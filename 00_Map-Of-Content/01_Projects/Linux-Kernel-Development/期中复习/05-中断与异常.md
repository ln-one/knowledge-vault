# 05 - 中断与异常

> 💡 **本章目标**：理解中断、陷阱、异常的区别，掌握IDT的结构和中断处理流程

> ⚠️ **重要程度**：⭐⭐（了解概念，理解流程）

---

## 📖 目录
1. [中断、陷阱、异常的区别](#中断陷阱异常的区别)
2. [IDT - 中断描述符表](#idt---中断描述符表)
3. [中断门和陷阱门](#中断门和陷阱门)
4. [中断处理流程](#中断处理流程)
5. [常见中断和异常](#常见中断和异常)

---

## 中断、陷阱、异常的区别

### 📊 三者对比

| 类型 | 来源 | 同步性 | 主动性 | 例子 |
|------|------|--------|--------|------|
| **中断(Interrupt)** | 外部硬件 | 异步 | 被动 | 键盘输入、定时器 |
| **陷阱(Trap)** | 软件指令 | 同步 | 主动 | int指令、系统调用 |
| **异常(Exception)** | 程序错误 | 异步 | 被动 | 除零、缺页 |

### 1️⃣ 中断 (Interrupt)

```
┌─────────────────────────────────────┐
│  外部中断                            │
├─────────────────────────────────────┤
│                                     │
│  来源：外部硬件设备                  │
│  ├─ 键盘按键                        │
│  ├─ 鼠标移动                        │
│  ├─ 定时器到期                      │
│  ├─ 硬盘读写完成                    │
│  └─ 网卡收到数据                    │
│                                     │
│  特点：                              │
│  ✓ 异步：无法预测何时发生            │
│  ✓ 被动：CPU被动响应                │
│  ✓ 可屏蔽：可以通过cli指令关闭       │
│                                     │
└─────────────────────────────────────┘
```

**可屏蔽中断 vs 不可屏蔽中断**：
```asm
; 可屏蔽中断
cli        ; 关中断（清除IF标志）
; ... 临界区代码 ...
sti        ; 开中断（设置IF标志）

; 不可屏蔽中断(NMI)
; 无法通过cli/sti控制
; 用于严重错误（如内存错误）
```

### 2️⃣ 陷阱 (Trap)

```
┌─────────────────────────────────────┐
│  陷阱（软件中断）                    │
├─────────────────────────────────────┤
│                                     │
│  来源：程序主动执行int指令           │
│  ├─ int 0x80  (Linux系统调用)       │
│  ├─ int 0x21  (DOS系统调用)         │
│  └─ int 3     (调试断点)            │
│                                     │
│  特点：                              │
│  ✓ 同步：执行int指令时发生           │
│  ✓ 主动：程序故意产生                │
│  ✓ 可预测：知道何时会发生            │
│                                     │
└─────────────────────────────────────┘
```

**系统调用示例**：
```asm
; Linux系统调用：write
mov eax, 4          ; sys_write
mov ebx, 1          ; stdout
mov ecx, msg        ; 消息地址
mov edx, len        ; 消息长度
int 0x80            ; 陷入内核
```

### 3️⃣ 异常 (Exception)

```
┌─────────────────────────────────────┐
│  异常                                │
├─────────────────────────────────────┤
│                                     │
│  来源：程序执行错误                  │
│  ├─ 除零异常 (#DE)                  │
│  ├─ 调试异常 (#DB)                  │
│  ├─ 断点异常 (#BP)                  │
│  ├─ 溢出异常 (#OF)                  │
│  ├─ 越界异常 (#BR)                  │
│  ├─ 无效操作码 (#UD)                │
│  ├─ 缺页异常 (#PF)                  │
│  └─ 通用保护异常 (#GP)              │
│                                     │
│  特点：                              │
│  ✓ 异步：不知道何时会犯错            │
│  ✓ 被动：不是故意的                  │
│  ✓ 可恢复：有些异常可以修复后继续    │
│                                     │
└─────────────────────────────────────┘
```

**常见异常**：
```
#DE (0)  : 除零异常
#DB (1)  : 调试异常
#BP (3)  : 断点异常
#OF (4)  : 溢出异常
#BR (5)  : 越界异常
#UD (6)  : 无效操作码
#NM (7)  : 设备不可用
#DF (8)  : 双重故障
#TS (10) : 无效TSS
#NP (11) : 段不存在
#SS (12) : 栈段错误
#GP (13) : 通用保护异常（最常见！）
#PF (14) : 缺页异常
```

---

## IDT - 中断描述符表

### 🎯 什么是IDT？

**IDT (Interrupt Descriptor Table)** = 中断描述符表

> 💡 **类比**：
> - GDT是段的"电话簿"
> - IDT是中断处理程序的"电话簿"

```
┌──────────────────────────────────────┐
│  IDT 结构                             │
├──────────────────────────────────────┤
│                                      │
│  索引0:  [除零异常处理程序]           │
│  索引1:  [调试异常处理程序]           │
│  索引2:  [NMI处理程序]                │
│  索引3:  [断点异常处理程序]           │
│  ...                                 │
│  索引13: [通用保护异常处理程序]       │
│  索引14: [缺页异常处理程序]           │
│  ...                                 │
│  索引32: [定时器中断处理程序]         │
│  索引33: [键盘中断处理程序]           │
│  ...                                 │
│  索引255: [用户定义]                  │
│                                      │
└──────────────────────────────────────┘
     ↑
     └─ 每个描述符8字节
```

### 📍 IDTR寄存器

```
┌─────────────────────────────────────┐
│  IDTR 寄存器结构 (48位)              │
├─────────────────────────────────────┤
│                                     │
│  ┌──────────┬──────────────────┐   │
│  │ 16位限界 │  32位基地址       │   │
│  └──────────┴──────────────────┘   │
│       ↓              ↓              │
│    IDT大小-1     IDT在内存中的地址  │
│                                     │
└─────────────────────────────────────┘
```

**加载IDTR的指令**：
```asm
lidt [IdtPtr]    ; 加载IDT
sidt [IdtPtr]    ; 保存IDT
```

### 💻 定义IDT

```asm
[SECTION .idt]
ALIGN 32
LABEL_IDT:
    ; 0-31: CPU异常
    Gate SelectorCode32, _divide_error, 0, DA_386IGate
    Gate SelectorCode32, _debug, 0, DA_386IGate
    Gate SelectorCode32, _nmi, 0, DA_386IGate
    Gate SelectorCode32, _breakpoint, 0, DA_386TGate
    ; ... 更多异常 ...
    
    ; 32-47: 硬件中断
    Gate SelectorCode32, _timer, 0, DA_386IGate
    Gate SelectorCode32, _keyboard, 0, DA_386IGate
    ; ... 更多中断 ...
    
    ; 48-255: 用户定义
    times 208 Gate 0, 0, 0, 0

IdtLen equ $ - LABEL_IDT
IdtPtr dw IdtLen - 1
       dd 0
```

---

## 中断门和陷阱门

### 📊 门描述符结构

```
┌────────────────────────────────────────────────────────────┐
│  低32位                                                     │
├────────────────────────────────────────────────────────────┤
│  31              16 15                                  0   │
│  ┌─────────────────┬──────────────────────────────────┐   │
│  │  段选择子       │  偏移量 (0-15)                    │   │
│  └─────────────────┴──────────────────────────────────┘   │
└────────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────────┐
│  高32位                                                     │
├────────────────────────────────────────────────────────────┤
│  31              16 15 14 13 12  8 7   5 4       0         │
│  ┌─────────────────┬──┬─────┬──┬─────┬─────┬────────────┐ │
│  │ 偏移量(16-31)   │P │ DPL │0 │类型 │ 000 │  保留      │ │
│  └─────────────────┴──┴─────┴──┴─────┴─────┴────────────┘ │
└────────────────────────────────────────────────────────────┘
```

### 🔍 中断门 vs 陷阱门

| 特性 | 中断门 | 陷阱门 |
|------|--------|--------|
| **类型码** | 1110 (0xE) | 1111 (0xF) |
| **IF标志** | 自动清除（关中断） | 不改变 |
| **用途** | 硬件中断 | 软件中断、异常 |
| **嵌套** | 防止中断嵌套 | 允许中断嵌套 |

```
中断门：
┌─────────────────────────────────────┐
│  进入中断处理程序                    │
│  ↓                                  │
│  CPU自动清除IF标志（关中断）         │
│  ↓                                  │
│  执行中断处理程序                    │
│  ↓                                  │
│  iret指令恢复IF标志                 │
└─────────────────────────────────────┘

陷阱门：
┌─────────────────────────────────────┐
│  进入异常处理程序                    │
│  ↓                                  │
│  IF标志不变                         │
│  ↓                                  │
│  执行异常处理程序                    │
│  ↓                                  │
│  iret指令返回                       │
└─────────────────────────────────────┘
```

### 💻 定义门描述符

```asm
; 中断门（用于硬件中断）
DA_386IGate equ 8Eh    ; P=1, DPL=0, Type=1110

; 陷阱门（用于异常和系统调用）
DA_386TGate equ 8Fh    ; P=1, DPL=0, Type=1111

; 定义中断门
Gate SelectorCode32, _timer_handler, 0, DA_386IGate
;    ↑               ↑                ↑  ↑
;    代码段选择子    处理程序偏移      参数  中断门

; 定义陷阱门
Gate SelectorCode32, _syscall_handler, 0, DA_386TGate
;                                         ↑
;                                      陷阱门
```

---

## 中断处理流程

### 🔄 完整的中断处理过程

```
┌─────────────────────────────────────────────────────────┐
│  1. 中断发生                                             │
│     硬件中断 / int指令 / 异常                            │
└─────────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────────┐
│  2. CPU保存当前状态                                      │
│     ├─ 如果特权级改变，切换栈                            │
│     ├─ 压入EFLAGS                                       │
│     ├─ 压入CS                                           │
│     ├─ 压入EIP                                          │
│     └─ 如果有错误码，压入错误码                          │
└─────────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────────┐
│  3. 查找中断处理程序                                     │
│     ├─ 根据中断号在IDT中查找门描述符                     │
│     ├─ 从门描述符获取段选择子和偏移                      │
│     └─ 如果是中断门，清除IF标志（关中断）                │
└─────────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────────┐
│  4. 跳转到中断处理程序                                   │
│     CS:EIP ← 门描述符中的段选择子:偏移                   │
└─────────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────────┐
│  5. 执行中断处理程序                                     │
│     ├─ 保存寄存器                                       │
│     ├─ 处理中断                                         │
│     └─ 恢复寄存器                                       │
└─────────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────────┐
│  6. 执行iret指令返回                                     │
│     ├─ 弹出EIP                                          │
│     ├─ 弹出CS                                           │
│     ├─ 弹出EFLAGS                                       │
│     └─ 如果特权级改变，恢复栈                            │
└─────────────────────────────────────────────────────────┘
```

### 📊 栈的变化

#### 无特权级改变

```
中断前：
┌──────────────┐
│  ...         │ ← ESP
└──────────────┘

中断后：
┌──────────────┐
│  ...         │
│  EFLAGS      │
│  CS          │
│  EIP         │
│  (错误码)    │ ← 如果有
└──────────────┘ ← ESP
```

#### 有特权级改变（Ring 3 → Ring 0）

```
中断前（Ring 3的栈）：
┌──────────────┐
│  ...         │ ← ESP_Ring3
└──────────────┘

中断后（Ring 0的栈）：
┌──────────────┐
│  SS_Ring3    │
│  ESP_Ring3   │
│  EFLAGS      │
│  CS_Ring3    │
│  EIP_Ring3   │
│  (错误码)    │ ← 如果有
└──────────────┘ ← ESP_Ring0
```

### 💻 中断处理程序示例

```asm
; 除零异常处理程序
_divide_error:
    push eax
    push ebx
    push ecx
    push edx
    
    ; 显示错误信息
    mov ax, SelectorVideo
    mov gs, ax
    mov edi, (80 * 0 + 0) * 2
    mov ah, 0Ch
    mov al, 'D'
    mov [gs:edi], ax
    
    pop edx
    pop ecx
    pop ebx
    pop eax
    
    iret    ; 中断返回

; 定时器中断处理程序
_timer:
    push eax
    
    ; 增加计数器
    inc dword [timer_ticks]
    
    ; 发送EOI（End Of Interrupt）到8259A
    mov al, 20h
    out 20h, al
    
    pop eax
    iret
```

### 🔧 IRET指令

```
IRET (Interrupt Return) 指令的操作：

1. pop EIP
2. pop CS
3. pop EFLAGS

如果CS的CPL改变（从Ring 0返回Ring 3）：
4. pop ESP
5. pop SS

IRET vs RET vs RETF：
- RET:  只弹出EIP
- RETF: 弹出EIP和CS
- IRET: 弹出EIP、CS、EFLAGS（可能还有ESP、SS）
```

---

## 常见中断和异常

### 📋 CPU异常（0-31）

| 中断号 | 名称 | 类型 | 错误码 | 说明 |
|--------|------|------|--------|------|
| 0 | #DE | Fault | 无 | 除零异常 |
| 1 | #DB | Fault/Trap | 无 | 调试异常 |
| 2 | - | Interrupt | 无 | NMI |
| 3 | #BP | Trap | 无 | 断点异常 |
| 4 | #OF | Trap | 无 | 溢出异常 |
| 5 | #BR | Fault | 无 | 越界异常 |
| 6 | #UD | Fault | 无 | 无效操作码 |
| 7 | #NM | Fault | 无 | 设备不可用 |
| 8 | #DF | Abort | 有(0) | 双重故障 |
| 10 | #TS | Fault | 有 | 无效TSS |
| 11 | #NP | Fault | 有 | 段不存在 |
| 12 | #SS | Fault | 有 | 栈段错误 |
| 13 | #GP | Fault | 有 | 通用保护异常 |
| 14 | #PF | Fault | 有 | 缺页异常 |

### 📋 硬件中断（32-47，8259A）

| 中断号 | IRQ | 设备 |
|--------|-----|------|
| 32 | IRQ0 | 定时器 |
| 33 | IRQ1 | 键盘 |
| 34 | IRQ2 | 级联 |
| 35 | IRQ3 | COM2 |
| 36 | IRQ4 | COM1 |
| 37 | IRQ5 | LPT2 |
| 38 | IRQ6 | 软盘 |
| 39 | IRQ7 | LPT1 |
| 40 | IRQ8 | 实时时钟 |
| 46 | IRQ14 | 硬盘 |

### 🔍 通用保护异常 (#GP)

**最常见的异常！**

```
触发条件：
✗ 访问不存在的段
✗ 特权级检查失败
✗ 写只读段
✗ 加载空选择子到CS/SS
✗ 访问超出段界限
✗ 等等...

调试技巧：
1. 检查段选择子是否正确
2. 检查特权级设置
3. 检查段界限
4. 检查段属性（可读/可写/可执行）
```

---

## 🎯 本章小结

### 核心概念

| 概念 | 说明 |
|------|------|
| **中断** | 外部硬件产生，异步，被动 |
| **陷阱** | 软件指令产生，同步，主动 |
| **异常** | 程序错误产生，异步，被动 |
| **IDT** | 中断描述符表，存放中断处理程序的入口 |
| **中断门** | 自动关中断，用于硬件中断 |
| **陷阱门** | 不关中断，用于异常和系统调用 |

### 中断处理流程

```
中断发生 → 保存状态 → 查IDT → 跳转处理程序 → 执行 → IRET返回
```

### 重要指令

```asm
cli     ; 关中断（清除IF）
sti     ; 开中断（设置IF）
lidt    ; 加载IDT
iret    ; 中断返回
int n   ; 软件中断
```

### 💡 记忆技巧

```
中断 = 外来电话（被动接听）
陷阱 = 主动打电话（主动拨号）
异常 = 打错电话（意外发生）
IDT = 电话簿（查找处理程序）
```

---

## ✅ 自我检查

- [ ] 能区分中断、陷阱、异常
- [ ] 能说出IDT的作用
- [ ] 能说出中断门和陷阱门的区别
- [ ] 能描述中断处理的完整流程
- [ ] 能说出常见的异常类型
- [ ] 能解释IRET指令的作用

---

**下一章**：[06-ELF文件格式.md](06-ELF文件格式.md) - 学习可执行文件的结构
