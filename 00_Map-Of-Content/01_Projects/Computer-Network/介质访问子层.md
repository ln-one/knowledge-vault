---
tags:
  - Knowledge/Computer-Network
created: 2025-10-28
author:
  - ln1
status: In Progress
---
![[Pasted image 20251028095330.png]]
## 1.信道分配问题：

### MAC子层位置
- **数据链路层分为两个子层**：
  - MAC子层：介质访问控制（Medium Access Control）
  - LLC子层：逻辑链路控制（承上启下，弱层）

> MAC子层处理"谁能发送"的问题，LLC子层处理"如何发送"的问题

### 信道类型
- **点到点信道**：信道直接连接两个端点
  - 例：家中计算机通过modem连接到电信公司端局
- **多点访问信道**：多用户共享一根信道（广播信道、随机访问信道）
  - 例：以太网的典型拓扑

### 常见的局域网拓扑
- **总线拓扑**、**星型拓扑**、**环型拓扑**(考)
- **共同点**：共享一根信道
- **核心问题**：某时由谁来访问共享信道？

> 早期以太网是总线拓扑，现在多为星型拓扑但逻辑上仍是总线（使用集线器时）

### 静态分配 vs 动态分配
#### 静态分配（TDM、FDM）
- **特点**：资源分配固定，延迟时间增大N倍
- **适用**：用户数量少且固定，通信量大且流量稳定
- **缺点**：资源浪费，效率低，不适用于突发性业务

#### 动态分配
- **目的**：更好地满足需求，提高信道利用率



## 2.多路访问协议

### 2.1 随机访问协议

#### ALOHA协议
##### 纯ALOHA协议
- **工作原理**：想发就发！（任性）
- **特点**：冲突不可避免，随时可能冲突，冲突的帧完全破坏
- **冲突危险期**：2D（D为单向传播延迟）
- **吞吐量**：S = Ge^(-2G)，最大吞吐率约18.4%（G=0.5时）

> 冲突危险期为2D是因为：A发送时，最远的B在D时间后才能检测到，如果B在A发送后D时间内发送，会在A处产生冲突

##### 分隙ALOHA协议
- **改进**：把时间分成时隙，帧的发送必须在时隙的起点
- **冲突危险期**：D（减半）
- **吞吐量**：S = Ge^(-G)，最大吞吐率约36.8%（G=1时）
- **优势**：是纯ALOHA的两倍

> 时隙同步使得冲突只能发生在时隙开始时刻，大大减少了冲突概率

#### CSMA协议（载波侦听多路访问）
- **核心思想**："先听后发"（不再任性，变得礼貌）

##### 非持续式CSMA
- **特点**：介质空闲则发送，介质忙则等待随机时间
- **优点**：减少再次碰撞可能性
- **缺点**：等待时间内介质空闲是浪费

##### 1-持续式CSMA
- **特点**：介质空闲立即发送，介质忙持续侦听
- **优点**：延迟时间少
- **缺点**：多个站等待时一定会发生冲突

##### p-持续式CSMA
- **特点**：介质空闲时以概率p发送，以(1-p)概率延迟
- **注意**：1-持续式是p-持续式的特例

#### CSMA/CD协议
- **全称**：Carrier Sense Multiple Access with Collision Detection
- **原理**："先听后发、边发边听"
- **冲突窗口**：2D（发送站发出帧后能检测到冲突的最长时间）
- **要求**：发送帧的时间不能太短，至少一个冲突窗口的时间
- **Jam信号**：一旦检测到冲突，发送强化信号

> CSMA/CD是以太网的核心协议，"边发边听"是关键，这要求全双工通信能力

### 2.2 受控访问协议（无冲突）

#### 位图协议（预留协议）
- **过程**：竞争期举手示意 → 传输期按序发送
- **信道利用率**：低负荷d/(d+N)，高负荷d/(d+1)

> 类似会议发言，先举手报名，再按顺序发言，避免了冲突但增加了开销

#### 令牌传递
- **原理**：令牌=发送权限，获得令牌才能发送
- **缺点**：令牌的维护代价

> 令牌环网络的经典协议，令牌丢失或重复都会导致网络故障

#### 二进制倒计数协议
- **特点**：高序号站点优先获得发送权
- **信道利用率**：d/(d+log₂N)

### 2.3 有限竞争协议
- **代表**：自适应树搜索协议
- **思想**：结合随机访问和受控访问的优势

## 3.以太网：
### 3.1 经典以太网

#### 物理层特征
- **最高速率**：10Mbps
- **编码方式**：曼彻斯特编码
- **连接方式**：同轴电缆和中继器
- **5-4-3-2-1原则**：任意两个收发器间距离≤2.5km，中继器≤4个

#### MAC帧格式
**两种标准**：
- **DIX Ethernet V2**（最常用）：类型字段表示上层协议
- **IEEE 802.3**：长度字段表示数据长度

**帧结构**：前导码(8) + 目的地址(6) + 源地址(6) + 类型/长度(2) + 数据(46~1500) + 校验和(4)

#### 帧长度要求
- **最小帧长**：64B（46+18，不足需填充Padding）
- **最大帧长**：1518B（1500+18，MTU=1500B）
- **64B的意义**：确保在冲突检测期间内能发送完整帧
- **无效帧判断**：
  - 长度不在46~1500字节
  - 帧长度不是整数字节
  - FCS校验错误
  - 数据字段长度与长度字段值不一致

> 64B最小帧长保证了在最坏情况下（2500米网络）能在冲突窗口内检测到冲突

#### MAC地址
- **长度**：6字节（48位）
- **组成**：OUI(3字节) + 厂商分配(3字节)
- **类型**：
  - 单播：正常MAC地址
  - 广播：FF-FF-FF-FF-FF-FF
  - 组播：第一字节最低位为1

#### CSMA/CD工作机制
- **二进制指数后退算法**：
  - 基本退避时间槽：512比特时间（2τ）
  - 重传次数k = min\[重传次数, 10\]
  - 随机数r从\[0, 2^k-1\]中选择
  - 重传延迟 = r × 2τ
  - 重传16次仍失败则丢弃

> 退避算法能自适应网络负载：冲突多时退避时间长，冲突少时退避时间短

#### 性能分析
- **信道效率** = 1/(1 + 2BLe/cF)
- P=F/B（F为帧长，B为带宽）
- L为电缆长度，c为信号传播速度
- **影响因素**：电缆越长、带宽越高，效率越低
### 3.2 交换式以太网

#### 集线器 vs 交换机
**集线器（HUB）**：
- 工作在**物理层**，所有端口内部连通
- 逻辑上等同于单根总线
- 所有站都在**同一个冲突域**，必须使用CSMA/CD
- 不能增加容量，限制网络可扩展性

**交换机（Switch）**：
- 工作在**数据链路层**，检查MAC帧目的地址进行转发
- 通过高速背板连接所有端口
- **每个端口独立的冲突域**
- 全双工模式下不需要CSMA/CD，可实现并行传输
- **混杂模式**：可用于网络分析和黑客攻击

> 交换机的出现是以太网发展的重要里程碑，从共享介质变为交换介质

![[Pasted image 20251028101322.png]]
![[Pasted image 20251028101834.png]]
### 3.3 以太网发展历程

#### 快速以太网（Fast Ethernet, IEEE 802.3u, 1995）
- **速率**：100Mbps（10倍提升）
- **保持兼容**：帧格式、接口、过程规则不变
- **新特性**：自动协商（autonegotiation）
- **主要标准**：
  - 100Base-TX：5类UTP，100米，全双工
  - 100Base-FX：光纤，2000米
  - 100Base-T4：3类UTP，100米

#### 千兆以太网（Gigabit Ethernet, IEEE 802.3ab, 1998）
- **速率**：1000Mbps（1Gbps）
- **工作方式**：全双工（缺省）和半双工
- **半双工改进**：载波扩充和帧突发（保证CSMA/CD工作）
- **新特性**：流量控制和巨型帧（Jumbo frame）
- **主要标准**：
  - 1000Base-T：5类UTP，100米
  - 1000Base-SX：多模光纤，550米
  - 1000Base-LX：单模光纤，5000米

#### 万兆以太网（10-Gigabit Ethernet, IEEE 802.3ae, 2002）
- **速率**：10Gbps
- **重要变化**：**只支持全双工**，不再使用CSMA/CD
- **编码**：64b/66b（提高效率）
- **重点**：超高速的物理层技术

#### 40G/100G以太网（IEEE 802.3ba, 2010）
- **速率**：40Gbps & 100Gbps
- **技术**：4×10G lanes（40G）、10×10G lanes（100G）
- **特点**：只支持全双工，保留以太网帧格式

#### 以太网的未来
- **25/50G以太网**：弥补10G低带宽和40G高成本缺陷
- **200G/400G以太网**：2017年标准获得批准
- **800G/1.6T以太网**：2020-2030年预期标准
- **成功原因**：不断增长的以太网生态系统，开放标准
## 4.数据链路层交换

### 核心概念
- **冲突域**：发生冲突的范围
- **广播域**：广播帧能够到达的范围
### 4.1.数据链路层交换原理
#### 物理层设计扩充网络
- 扩大了冲突域，性能降低，安全隐患
#### 数据链路层设备扩充网络：
- 网桥或交换机
- 分隔了冲突域
理想的网桥是**透明**的：
- 即插即用，无需任何配置
- 网络中的站点**无需感知**网桥的存在与否。
#### MAC地址表的构建
- 逆向学习**源地址**；
- 设定**老化时间**（默认300S），当老化时间到期时，该表项会被清除。
• 增加表项：帧的源地址对应的项不在表中
• 删除表项：老化时间到期
• 更新表项：帧的源地址在表中，更新时间戳

> 逆向学习是透明网桥的核心机制，通过观察帧的源地址来学习网络拓扑
![[Pasted image 20251028105938.png]]
![[Pasted image 20251028110004.png]]
![[Pasted image 20251028110036.png]]
#### 网桥转发行为
**Flooding（泛洪）**
两种目的地址的帧，需要泛洪：
• 广播帧：目的地址为**FF-FF-FF-FF-FF-FF**的数据帧
• 未知单播帧：**目的地址不在MAC地址转发表**中的单播数据帧

> 泛洪是必要的恶：保证连通性但浪费带宽，这就是为什么要尽快学习MAC地址
### 4.2.链路层交换机
- 多端口透明网桥，网桥的现代名称。
- 一种即插即用设备
![[Pasted image 20251028110756.png]]
![[Pasted image 20251028110805.png]]
#### 交换方式：
- 对称交换
- 非对称交换
#### 交换模式：从转发时机角度：
##### 1.存储转发模式（Store and Forward)
- 特点：转发前必须接收**整个帧**，执行CRC校验
- 缺点：延迟大
- 优点：不转发出错帧、支持非对称交换

> 最安全的转发方式，现代交换机的主流模式
##### 2.直通交换（Cut-through）
- 特点：一旦接收到**帧的目的地址**，就开始转发
- 缺点：可能转发错误帧，不支持非对称交换
- 优点：延迟小，可以边入边出

> 追求极低延迟的应用场景使用，如高频交易系统
##### 3.无碎片交换（Fragment-free）
- 特点：接收到**帧的前64字节**，即开始转发
- 缺点：仍可能转发错误帧，不支持非对称交换。
- 优点：过滤了冲突碎片，延迟中等

> 折中方案：64字节能过滤掉大部分冲突产生的碎片帧


### 4.3 生成树协议（STP）

#### 物理环路的问题
1. **广播风暴**：广播帧无限循环，消耗网络资源
2. **重复帧**：目的设备收到重复的帧副本
3. **MAC地址表不稳定**：同一MAC地址对应端口不断变化

#### STP工作原理
- **发明人**：Radia Perlman（1983年）
- **目标**：打破物理环，维护逻辑无环树
- **关键信息**：BPDU（桥协议数据单元）包含：
  - 根桥ID（Root ID）
  - 根路径开销（Root Path Cost）
  - 指定桥ID（Designated Bridge ID）
  - 指定端口ID（Designated Port ID）

> STP的核心思想：在有冗余链路的网络中构建一棵无环的生成树

#### 三个选举过程

**1. 选举根桥（Root Bridge）**
- **规则**：桥ID最小的成为根桥
- **桥ID组成**：优先级（2字节）+ MAC地址（6字节）
- **比较方法**：
  - 先比较优先级，数值小的优先
  - 优先级相同，比较MAC地址，数值小的优先
- **举例**：
  - 交换机A：优先级32768，MAC 00-0A-00-11-11-11
  - 交换机B：优先级24576，MAC 00-0A-00-33-33-33
  - 结果：B成为根桥（优先级更小）

![[Pasted image 20251104113423.png]]

> 根桥就像树的根部，是整个生成树的中心，所有路径计算都以它为基准

**2. 选举根端口（Root Port）**
- **规则**：每个非根桥选出到根桥开销最小的端口
- **什么是根路径开销？**
  - 根桥的根路径开销 = 0（它就是根）
  - 非根桥的根路径开销 = 到根桥路径上所有链路开销之和
  
- **链路开销表**（IEEE 802.1D标准）：

  | 速率 | 开销 |
  |------|------|
  | 10Mbps | 100 |
  | 100Mbps | 19 |
  | 1Gbps | 4 |
  | 10Gbps | 2 |

- **选举步骤**：
  1. 计算每个端口到根桥的路径开销
  2. 选择开销最小的端口作为根端口
  3. 如果开销相同，选择端口ID最小的

- **举例**：
  ```
  交换机C有两个端口连接到根桥：
  - F0/1：经过一条100Mbps链路，开销 = 19
  - F0/2：经过两条100Mbps链路，开销 = 19+19 = 38
  结果：F0/1成为根端口（开销更小）
  ```

![[Pasted image 20251104114143.png]]

> 根端口是非根桥通往根桥的"最佳路径"，每个非根桥只有一个根端口

**3. 选举指定端口（Designated Port）**
- **规则**：每个网段选出根路径开销最小的端口
- **什么是网段？**
  - 两个交换机之间的连接就是一个网段
  
- **选举步骤**：
  1. 对于每个网段，比较连接到它的所有端口
  2. 选择根路径开销最小的端口
  3. 如果开销相同，选择所属交换机桥ID小的端口
  4. 如果桥ID也相同，选择端口ID小的

- **举例**：
  ```
  网段X连接交换机A和B：
  - A的端口：到根桥开销 = 19
  - B的端口：到根桥开销 = 38
  结果：A的端口成为指定端口（开销更小）
  ```

![[Pasted image 20251104114612.png]]

> 指定端口负责该网段的数据转发，每个网段只有一个指定端口

**端口角色总结**：
- **根端口**：非根桥通往根桥的最佳路径（转发状态）
- **指定端口**：负责网段数据转发的端口（转发状态）
- **阻塞端口**：既不是根端口也不是指定端口（阻塞状态，防止环路）
> 选举顺序很重要：先选根桥，再选根端口，最后选指定端口

#### 端口状态
- **Forwarding**：转发状态（指定端口、根端口）
- **Blocking**：阻塞状态（非指定非根端口）
- **Listening/Learning**：过渡状态（各15秒）

#### RSTP改进
- **快速收敛**：几百毫秒（vs STP的30秒）
- **边缘端口**：直连终端设备，可直接进入转发状态

### 4.4 虚拟局域网（VLAN）

#### VLAN基本概念
- **定义**：在物理网络上根据用途、工作组逻辑划分的局域网
- **目的**：分隔广播域，提高安全性和可管理性
- **特点**：与用户物理位置无关

> VLAN实现了"一个物理网络，多个逻辑网络"的概念

#### VLAN类型

**1. 基于端口的VLAN**（最常见）
- **原理**：交换机的端口直接分配给某个VLAN
- **举例**：
  ```
  交换机有24个端口：
  - 端口1-12 → VLAN 10（开发部）
  - 端口13-24 → VLAN 20（市场部）
  ```
- **优点**：配置简单，管理方便
- **缺点**：用户移动位置需要重新配置

![[Pasted image 20251111101549.png]]

> 就像给每个房间贴标签，进入这个房间的人自动属于这个部门

**2. 基于MAC地址的VLAN**
- **原理**：根据设备的MAC地址决定VLAN成员身份
- **举例**：
  ```
  MAC地址 → VLAN映射：
  - 00-11-22-33-44-55 → VLAN 10
  - AA-BB-CC-DD-EE-FF → VLAN 20
  ```
- **优点**：用户移动位置不需要重新配置
- **缺点**：需要维护MAC地址表，管理复杂

> 就像身份证号，无论你走到哪里，身份不变

**3. 基于协议的VLAN**
- **原理**：根据网络层协议类型划分VLAN
- **举例**：
  ```
  - 所有IP流量 → VLAN 10
  - 所有IPX流量 → VLAN 20
  ```
- **应用场景**：多协议网络环境
- **缺点**：现在很少使用（因为IP协议占主导）

> 就像按语言分组，说英语的一组，说中文的一组

**4. 基于子网的VLAN**
- **原理**：根据IP子网划分VLAN
- **举例**：
  ```
  - 192.168.1.0/24 → VLAN 10
  - 192.168.2.0/24 → VLAN 20
  ```
- **优点**：与网络层规划一致
- **缺点**：需要检查IP地址，增加处理开销

> 就像按地区分组，北京的一组，上海的一组

#### IEEE 802.1Q标准

**VLAN标记的作用**
- **问题**：不同VLAN的数据帧在Trunk链路上传输时，如何区分？
- **解决**：在帧中插入4字节的VLAN标记

**帧的类型**
- **无标记帧（Untagged Frame）**：普通以太网帧，没有VLAN信息
- **标记帧（Tagged Frame）**：携带VLAN标记的帧

**VLAN标记结构**（4字节）
```
原始以太网帧：
[目的MAC][源MAC][类型][数据][FCS]

802.1Q标记帧：
[目的MAC][源MAC][VLAN标记(4字节)][类型][数据][FCS]
                    ↓
        [TPID(2字节)][TCI(2字节)]
```

**详细字段说明**：

1. **TPID**（Tag Protocol Identifier，2字节）
   - 固定值：0x8100
   - 作用：标识这是一个802.1Q帧

2. **TCI**（Tag Control Information，2字节）
   - **优先级（Priority，3 bit）**：
     - 取值：0-7，数字越大优先级越高
     - 用途：QoS服务质量控制
     - 举例：7=网络控制，6=语音，0=尽力而为
   
   - **CFI（Canonical Format Indicator，1 bit）**：
     - 取值：0或1
     - 用途：兼容性标识（以太网中通常为0）
   
   - **VLAN ID（12 bit）**：
     - 取值：0-4095（共4096个）
     - 有效范围：1-4094（0和4095保留）
     - 用途：标识VLAN编号

**工作流程举例**：
```
1. PC发送普通帧 → Access端口
   [目的MAC][源MAC][类型][数据][FCS]

2. 交换机在Access端口接收，添加VLAN标记
   [目的MAC][源MAC][VLAN 10标记][类型][数据][FCS]

3. 通过Trunk端口发送到另一台交换机
   （标记帧在Trunk链路上传输）

4. 目标交换机接收，剥除VLAN标记
   [目的MAC][源MAC][类型][数据][FCS]

5. 从Access端口发送给目标PC
   （PC收到的是普通帧，不知道VLAN的存在）
```

> VLAN标记就像快递包裹上的标签，在中转站之间传递时需要标签，送到收件人手里时标签被撕掉

**关键概念**：
- **透明性**：终端设备（PC）不需要知道VLAN的存在
- **标记添加/剥除**：由交换机自动完成
- **Trunk链路**：传输标记帧
- **Access链路**：传输无标记帧
#### 端口类型

**Access端口**
- **用途**：连接终端设备（PC、打印机、服务器等）
- **特点**：
  - 只能属于一个VLAN
  - 发送无标记帧（Untagged）
  - 接收帧时自动添加VLAN标记
  - 发送帧时自动剥除VLAN标记
  
- **配置举例**：
  ```
  交换机端口1配置：
  - 端口类型：Access
  - PVID（Port VLAN ID）：10
  
  工作过程：
  1. PC发送普通帧 → 端口1
  2. 端口1添加VLAN 10标记
  3. 帧在交换机内部转发
  4. 从目标Access端口发出时剥除标记
  5. 目标PC收到普通帧
  ```

> Access端口就像小区的单元门，只属于一个单元，进出的人不需要带单元号牌

**Trunk端口**
- **用途**：连接交换机之间，或连接交换机与路由器
- **特点**：
  - 可以传输多个VLAN的流量
  - 发送标记帧（Tagged）
  - 保持VLAN标记不变
  - 需要配置允许通过的VLAN列表
  
- **配置举例**：
  ```
  交换机间连接端口配置：
  - 端口类型：Trunk
  - 允许VLAN：10, 20, 30
  - Native VLAN：1（可选）
  
  工作过程：
  1. 交换机A收到VLAN 10的帧
  2. 从Trunk端口发出（保持VLAN 10标记）
  3. 交换机B的Trunk端口接收
  4. 根据VLAN 10标记转发到对应端口
  ```

> Trunk端口就像高速公路，可以同时通行多个车队（VLAN），每个车队有自己的标识

**两种端口的对比**：

| 特性 | Access端口 | Trunk端口 |
|------|-----------|-----------|
| 连接对象 | 终端设备 | 交换机/路由器 |
| VLAN数量 | 1个 | 多个 |
| 帧类型 | 无标记帧 | 标记帧 |
| 标记处理 | 添加/剥除 | 保持不变 |
| 应用场景 | 用户接入 | 设备互联 |

**实际网络示例**：
```
        [PC A]          [PC B]
          |               |
      Access端口      Access端口
      (VLAN 10)       (VLAN 20)
          |               |
        [交换机1]----------[交换机2]
              Trunk端口
           (VLAN 10,20)
```

**Native VLAN（本征VLAN）**：
- Trunk端口上的一个特殊VLAN
- 该VLAN的帧在Trunk上传输时不打标记
- 默认为VLAN 1
- 两端交换机的Native VLAN必须一致

> Native VLAN就像VIP通道，不需要检票（标记）就能通过

#### VLAN优点
- 有效控制广播域范围
- 增强网络安全性（VLAN间隔离）
- 灵活构建虚拟工作组
- 提高网络可管理性

## 5.无线局域网（WLAN）

### 5.1 基本概念
- **定义**：以无线信道作为传输介质的计算机局域网
- **设计目标**：
  - 小覆盖范围（受限发射功率）
  - 使用无需授权的频谱（ISM频段）
  - 面向高速率应用
  - 支持实时和非实时应用

### 5.2 组网模式

#### 基础架构模式
- **分布式系统（DS）**：连接多个AP的骨干网络
- **访问点（AP）**：无线接入点
- **站点（STA）**：无线终端设备
- **基本服务集（BSS）**：一个AP管理的区域
- **扩展服务集（ESS）**：多个BSS组成的网络
- **通信方式**：站点间通信通过AP转发

#### 自组织模式（Ad hoc）
- **独立基本服务集（IBSS）**：无AP的对等网络
- **通信方式**：站点间直接通信
- **特点**：共享同一无线信道
 
### 5.3 IEEE 802.11体系结构
- **物理介质相关子层（PMD）**：调制解调、编码/解码
- **物理层汇聚协议（PLCP）**：提供独立于传输技术的接口
- **介质访问控制层（MAC）**：可靠数据传输、介质访问控制、安全机制

### 5.4 物理层技术
- **频段**：2.4GHz、5GHz（ISM频段，无需授权，功率≤1瓦）
- **调制技术演进**：DPSK → QPSK → CCK → 64-QAM → 256-QAM → 1024-QAM
- **技术演进**：DSSS → OFDM → OFDMA
- **天线技术**：单天线 → SU-MIMO → MU-MIMO

### 5.5 CSMA/CA协议

#### 无线环境的挑战

**1. 冲突检测困难**
- **问题**：无线网卡在发送时无法同时接收
- **原因**：
  - 发送功率很大（如100mW）
  - 接收到的信号很弱（可能只有0.001mW）
  - 发送信号会"淹没"接收信号
  
- **对比有线网络**：
  - 有线：可以边发边听（CSMA/CD）
  - 无线：只能发送完再听（CSMA/CA）

> 就像你在用大喇叭喊话时，听不到别人的小声说话

**2. 隐藏终端问题（Hidden Terminal Problem）**
- **场景描述**：
  ```
  A ←→ B ←→ C
  
  - A和C都在B的通信范围内
  - 但A和C互相不在对方的通信范围内
  - A和C都想给B发送数据
  ```

- **问题过程**：
  1. A侦听信道，发现空闲（因为听不到C）
  2. C也侦听信道，发现空闲（因为听不到A）
  3. A和C同时向B发送数据
  4. 在B处发生冲突！
  5. 但A和C都不知道发生了冲突

- **后果**：
  - 数据在接收端B处冲突
  - 发送端A和C无法检测到冲突
  - 导致数据丢失

> 就像两个人在房间两端同时跟中间的人说话，中间的人听不清，但两端的人互相听不到对方

**3. 暴露终端问题（Exposed Terminal Problem）**
- **场景描述**：
  ```
  A ←→ B ←→ C ←→ D
  
  - B正在向A发送数据
  - C想向D发送数据
  ```

- **问题过程**：
  1. B正在向A发送数据
  2. C侦听信道，发现信道忙（听到了B的发送）
  3. C认为不能发送，等待
  4. 但实际上C→D的传输不会干扰B→A的传输
  5. C的等待是不必要的，浪费了信道资源

- **后果**：
  - 降低了网络吞吐量
  - 信道利用率下降

> 就像你在房间一端打电话，另一端的人以为会干扰你，其实不会

**三个问题的对比**：

| 问题 | 原因 | 后果 | 解决方案 |
|------|------|------|----------|
| 冲突检测困难 | 发送时无法接收 | 无法及时发现冲突 | 使用确认机制 |
| 隐藏终端 | 发送端互相听不到 | 在接收端冲突 | RTS/CTS机制 |
| 暴露终端 | 误判信道忙 | 降低吞吐量 | 智能退避算法 |

> 无线环境比有线环境复杂得多：信号衰减、多径传播、移动性等都是挑战

#### CSMA/CA工作机制
- **核心思想**：Collision Avoidance（冲突避免）
- **工作流程**：
  1. 信道空闲时间>IFS，立即传输
  2. 信道忙时，延迟到传输结束+IFS
  3. 二进制指数退后：从\[0, CWindow\]选择随机数
  4. 退后过程中信道忙则挂起，结束后恢复

#### 帧间隙（IFS）优先级控制
- **SIFS**（最高优先级）：用于Ack、CTS、轮询响应
- **PIFS**（中等优先级）：轮询服务
- **DIFS**（最低优先级）：异步数据服务

#### RTS-CTS机制（可选）

**目的**：解决隐藏终端问题，避免长帧冲突

**工作流程**（以A→B传输为例）：

```
时间轴：
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━→

1. A发送RTS（Request To Send）
   ┌─────┐
   │ RTS │ → B
   └─────┘
   内容：我要给B发送数据，需要占用信道X秒
   
2. B收到RTS，回复CTS（Clear To Send）
         ┌─────┐
   B → │ CTS │
         └─────┘
   内容：同意，你可以发送，其他站点请等待X秒
   
3. A收到CTS，开始发送数据
   ┌──────────┐
   │   DATA   │ → B
   └──────────┘
   
4. B收到数据，发送ACK确认
         ┌─────┐
   B → │ ACK │
         └─────┘
```

**关键概念：NAV（Network Allocation Vector，网络分配向量）**

- **什么是NAV？**
  - 一个虚拟的定时器
  - 记录信道被占用的剩余时间
  - 实现"虚拟载波侦听"

- **NAV的工作原理**：
  ```
  1. 站点C听到A发送的RTS
     - RTS中包含：需要占用信道30ms
     - C设置NAV = 30ms
     - C在30ms内不会尝试发送
  
  2. 站点D听到B发送的CTS
     - CTS中包含：需要占用信道30ms
     - D设置NAV = 30ms
     - D在30ms内不会尝试发送
  
  3. NAV倒计时
     - 30ms → 29ms → 28ms → ... → 0
     - NAV=0时，信道空闲，可以竞争
  ```

**解决隐藏终端问题的过程**：

```
场景：A ←→ B ←→ C（A和C互相听不到）

没有RTS/CTS：
1. A向B发送数据
2. C听不到A，以为信道空闲
3. C也向B发送数据
4. 在B处发生冲突 ✗

使用RTS/CTS：
1. A向B发送RTS
2. B回复CTS（C能听到CTS！）
3. C收到CTS，设置NAV，等待
4. A向B发送数据（成功！）✓
5. NAV倒计时结束，C可以竞争信道
```

**RTS/CTS帧的结构**：

```
RTS帧：
┌──────────┬──────────┬──────────┬──────────┐
│ 帧控制   │ 持续时间 │ 接收地址 │ 发送地址 │
│ (2字节)  │ (2字节)  │ (6字节)  │ (6字节)  │
└──────────┴──────────┴──────────┴──────────┘
           ↑
      需要占用信道的时间

CTS帧：
┌──────────┬──────────┬──────────┐
│ 帧控制   │ 持续时间 │ 接收地址 │
│ (2字节)  │ (2字节)  │ (6字节)  │
└──────────┴──────────┴──────────┘
           ↑
      需要占用信道的时间
```

**优缺点分析**：

**优点**：
- 有效解决隐藏终端问题
- 减少长帧冲突的代价
- 提高大数据传输的成功率

**缺点**：
- 增加了额外开销（RTS+CTS）
- 对短帧来说，开销比例太大
- 降低了短帧传输的效率

**使用策略**：
```
if (数据帧长度 > 阈值) {
    使用RTS/CTS机制
} else {
    直接发送数据帧
}

典型阈值：2346字节（可配置）
```

**实际应用举例**：
```
场景1：发送1500字节的数据
- RTS(20字节) + CTS(14字节) + Data(1500字节) + ACK(14字节)
- 总开销：48字节
- 开销比例：3.2%
- 结论：值得使用 ✓

场景2：发送100字节的数据
- RTS(20字节) + CTS(14字节) + Data(100字节) + ACK(14字节)
- 总开销：48字节
- 开销比例：48%
- 结论：不值得使用 ✗
```

> RTS-CTS就像预约机制：先打个招呼（RTS），得到同意（CTS），再开始正式交流（DATA）

**记忆口诀**：
- RTS：我要说话（Request To Send）
- CTS：你说吧（Clear To Send）
- NAV：别人等待（Network Allocation Vector）
- ACK：收到了（Acknowledgment）

#### 差错控制
- **检测**：32位CRC校验
- **重传**：停等机制，超时重传
- **分段**：应对无线链路高出错率

> 无线链路出错率比有线高1-2个数量级，必须采用更强的差错控制

### 5.6 QoS增强（EDCA）

**EDCA = Enhanced Distributed Channel Access（增强型分布式信道访问）**

**为什么需要QoS？**
- **问题**：传统CSMA/CA对所有数据一视同仁
- **现实需求**：
  - 视频通话需要低延迟
  - 文件下载可以稍微等待
  - 网页浏览介于两者之间

**EDCA的核心思想**：给不同类型的数据分配不同的优先级

#### 队列分类（Access Category，AC）

```
优先级从高到低：

AC3 (最高优先级)
┌─────────────────────────────────┐
│ 语音（Voice）                    │
│ - VoIP通话                       │
│ - 实时语音                       │
│ - 要求：低延迟、低抖动           │
└─────────────────────────────────┘

AC2
┌─────────────────────────────────┐
│ 视频（Video）                    │
│ - 视频会议                       │
│ - 流媒体                         │
│ - 要求：较低延迟、稳定带宽       │
└─────────────────────────────────┘

AC1
┌─────────────────────────────────┐
│ 尽力而为（Best Effort）          │
│ - 网页浏览                       │
│ - 普通数据传输                   │
│ - 要求：无特殊要求               │
└─────────────────────────────────┘

AC0 (最低优先级)
┌─────────────────────────────────┐
│ 背景流（Background）             │
│ - 文件下载                       │
│ - 系统更新                       │
│ - 要求：不影响其他应用           │
└─────────────────────────────────┘
```

#### 控制参数详解

**1. CWmin（最小竞争窗口）**
- **作用**：退避算法的最小窗口大小
- **原理**：窗口越小，等待时间越短，优先级越高
- **举例**：
  ```
  AC3 (语音)：CWmin = 3    → 从[0,3]中选择
  AC2 (视频)：CWmin = 7    → 从[0,7]中选择
  AC1 (数据)：CWmin = 15   → 从[0,15]中选择
  AC0 (背景)：CWmin = 31   → 从[0,31]中选择
  
  结果：语音最快获得发送机会
  ```

**2. CWmax（最大竞争窗口）**
- **作用**：退避算法的最大窗口大小
- **原理**：发生冲突时，窗口翻倍，但不超过CWmax
- **举例**：
  ```
  AC3 (语音)：CWmax = 7
  AC0 (背景)：CWmax = 1023
  
  发生冲突后：
  - 语音：窗口最多扩大到7
  - 背景：窗口可以扩大到1023
  
  结果：语音即使冲突也能快速重试
  ```

**3. AIFS（仲裁帧间间隔）**
- **作用**：发送前必须等待的空闲时间
- **计算公式**：AIFS = SIFS + AIFSN × 槽口时间
- **原理**：等待时间越短，优先级越高
- **举例**：
  ```
  SIFS = 10μs，槽口时间 = 9μs
  
  AC3 (语音)：AIFSN = 2 → AIFS = 10 + 2×9 = 28μs
  AC2 (视频)：AIFSN = 2 → AIFS = 10 + 2×9 = 28μs
  AC1 (数据)：AIFSN = 3 → AIFS = 10 + 3×9 = 37μs
  AC0 (背景)：AIFSN = 7 → AIFS = 10 + 7×9 = 73μs
  
  结果：语音和视频最先开始竞争
  ```

**4. TXOP（传输机会）**
- **作用**：一次获得信道后可以连续发送的时间
- **单位**：微秒（μs）
- **原理**：时间越长，一次可以发送越多数据
- **举例**：
  ```
  AC3 (语音)：TXOP = 1504μs
  AC2 (视频)：TXOP = 3008μs
  AC1 (数据)：TXOP = 0 (只能发一帧)
  AC0 (背景)：TXOP = 0 (只能发一帧)
  
  结果：视频可以连续发送多帧，提高效率
  ```

#### 工作流程示例

```
场景：同时有语音、视频、数据要发送

时间轴：
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━→

1. 信道空闲
   
2. 等待AIFS
   AC3 (语音)：等待28μs ✓ 最先结束
   AC2 (视频)：等待28μs ✓ 同时结束
   AC1 (数据)：等待37μs ... 还在等
   AC0 (背景)：等待73μs ... 还在等
   
3. 语音和视频开始退避
   AC3：从[0,3]选择 → 假设选到1
   AC2：从[0,7]选择 → 假设选到5
   
4. 语音先发送完成
   AC3：发送语音数据 ✓
   
5. 视频继续退避
   AC2：继续等待...
   AC1：AIFS结束，开始退避
   AC0：还在等待AIFS...
```

#### 参数对比表

| AC | 类型 | CWmin | CWmax | AIFSN | TXOP | 应用 |
|----|------|-------|-------|-------|------|------|
| AC3 | 语音 | 3 | 7 | 2 | 1504μs | VoIP |
| AC2 | 视频 | 7 | 15 | 2 | 3008μs | 视频会议 |
| AC1 | 数据 | 15 | 1023 | 3 | 0 | 网页浏览 |
| AC0 | 背景 | 31 | 1023 | 7 | 0 | 文件下载 |

> EDCA就像医院的分诊系统：急诊（语音）优先，普通门诊（数据）排队等候

**实际效果**：
- 语音通话：延迟低，通话清晰
- 视频会议：画面流畅，不卡顿
- 文件下载：速度可能慢一些，但不影响通话和视频
- 整体体验：大幅提升

### 5.7 802.11帧格式
- **帧控制**：协议版本、类型、子类型等
- **地址字段**：最多4个地址（DA、SA、BSSID等）
- **主要帧类型**：
  - 管理帧：Beacon、关联请求/响应、认证等
  - 控制帧：RTS、CTS、ACK等
  - 数据帧：普通数据帧、QoS数据帧等

### 5.8 网络管理
#### 关联过程
1. **扫描**：被动扫描（接收Beacon）或主动扫描（发送Probe Request）
2. **认证**：开放系统认证、共享密钥认证、WPA PSK、802.1X EAP
3. **关联**：发送关联请求，接收关联响应

#### 移动性管理
- **漫游**：通过重关联请求切换到新AP
- **睡眠管理**：TIM（流量指示映射）通知睡眠站点有数据

### 5.9 Wi-Fi 6核心技术（802.11ax）

**Wi-Fi 6的设计目标**：
- 在高密度环境（如体育场、机场）下提升性能
- 用户平均吞吐量提升4倍
- 并发用户数提升3倍

#### 1. OFDMA（正交频分多址）

**Wi-Fi 5 vs Wi-Fi 6的区别**：

```
Wi-Fi 5 (OFDM)：
时间片1：用户A独占整个信道
时间片2：用户B独占整个信道
时间片3：用户C独占整个信道

┌─────────────────────────┐
│         用户A           │ 时间片1
├─────────────────────────┤
│         用户B           │ 时间片2
├─────────────────────────┤
│         用户C           │ 时间片3
└─────────────────────────┘
    整个信道带宽

问题：即使用户只发送少量数据，也要占用整个信道


Wi-Fi 6 (OFDMA)：
同一时间片：多个用户同时使用不同的子信道

┌────────┬────────┬────────┐
│ 用户A  │ 用户B  │ 用户C  │ 同一时间片
└────────┴────────┴────────┘
  子信道1  子信道2  子信道3

优势：多个用户并行传输，效率更高
```

**资源单元（RU）**：
- 信道被分成固定大小的RU
- 最小RU = 26个子载波
- AP可以灵活分配RU给不同用户

**实际效果**：
```
场景：10个用户同时上网
- Wi-Fi 5：轮流使用信道，每人等待时间长
- Wi-Fi 6：同时使用不同RU，等待时间短

结果：延迟降低，响应更快
```

> OFDMA就像把一条宽马路分成多条车道，多辆车可以并行通过

#### 2. MU-MIMO（多用户多输入多输出）

**MIMO的演进**：
```
SU-MIMO (单用户MIMO)：
AP的多根天线 → 同一个用户
┌──┐
│AP│ ═══════════════════> [用户A]
│4 │ ═══════════════════> [用户A]
│天│ ═══════════════════> [用户A]
│线│ ═══════════════════> [用户A]
└──┘
问题：其他用户要等待


MU-MIMO (多用户MIMO)：
AP的多根天线 → 不同的用户
┌──┐
│AP│ ═══════════════════> [用户A]
│8 │ ═══════════════════> [用户B]
│天│ ═══════════════════> [用户C]
│线│ ═══════════════════> [用户D]
└──┘
优势：多个用户同时传输
```

**Wi-Fi 6的改进**：
- Wi-Fi 5：下行4×4 MU-MIMO
- Wi-Fi 6：上下行8×8 MU-MIMO

**实际应用**：
```
场景：8个用户同时下载
- Wi-Fi 5：最多4个用户同时下载
- Wi-Fi 6：最多8个用户同时下载

结果：并发能力翻倍
```

> MU-MIMO就像老师同时给多个学生讲不同的内容

#### 3. 1024-QAM（高阶调制）

**QAM = 正交幅度调制**

**调制阶数的演进**：
```
Wi-Fi 4：64-QAM
- 每个符号传输6比特 (2^6 = 64)

Wi-Fi 5：256-QAM
- 每个符号传输8比特 (2^8 = 256)

Wi-Fi 6：1024-QAM
- 每个符号传输10比特 (2^10 = 1024)
```

**速率提升**：
```
相同时间内：
- 256-QAM：传输8比特
- 1024-QAM：传输10比特

提升：10/8 = 1.25 = 25%
```

**代价**：
- 需要更好的信号质量
- 对信噪比要求更高
- 距离太远或干扰太大时会降级

> 1024-QAM就像用更复杂的密码本，同样的时间能传递更多信息

#### 4. BSS着色（BSS Coloring）

**问题场景**：
```
两个相邻的Wi-Fi网络使用同一信道：

AP1 (红色)          AP2 (蓝色)
  |                    |
[用户A]              [用户B]

传统做法：
- 用户A听到AP2的信号，认为信道忙
- 用户A等待，即使AP2的信号很弱
- 浪费了传输机会
```

**BSS着色的解决方案**：
```
给每个BSS分配一个"颜色"（6比特，0-63）

AP1 (颜色=5)        AP2 (颜色=10)
  |                    |
[用户A]              [用户B]

工作过程：
1. 用户A收到信号，检查颜色
2. 如果颜色=5（同色）：
   - 使用低CCA阈值（-82dBm）
   - 认为信道忙，等待
3. 如果颜色≠5（异色）：
   - 使用高CCA阈值（-62dBm）
   - 如果信号弱于-62dBm，认为信道空闲
   - 可以传输！
```

**实际效果**：
```
场景：密集的公寓楼，每家都有Wi-Fi
- 传统：互相干扰，速度慢
- BSS着色：识别邻居信号，合理共存

结果：同频并发，吞吐量提升
```

> BSS着色就像给每个Wi-Fi网络贴上颜色标签，识别"自己人"和"外人"

#### 5. TWT（目标唤醒时间）

**问题**：
- 移动设备需要省电
- 传统方式：定期唤醒检查是否有数据
- 浪费电量

**TWT的解决方案**：
```
协商过程：
1. 设备对AP说："我每100ms醒来一次"
2. AP记录：设备A在时刻T醒来
3. AP在T时刻发送数据
4. 设备在T时刻醒来接收数据
5. 其他时间设备睡眠

传统方式：
设备：醒→查→睡→醒→查→睡→醒→查→睡
      ↑   ↑   ↑   ↑   ↑   ↑   ↑   ↑   ↑
      频繁唤醒，浪费电量

TWT方式：
设备：睡→睡→睡→醒→收→睡→睡→睡→醒→收
                ↑           ↑
            只在需要时醒来
```

**实际效果**：
```
场景：智能家居设备（如温度传感器）
- 传统：每秒醒来检查，电池1个月
- TWT：每10分钟醒来，电池1年

结果：电池寿命大幅延长
```

> TWT就像预约机制，约好时间再见面，不用一直等着

#### Wi-Fi 6技术总结

| 技术 | 作用 | 提升 | 适用场景 |
|------|------|------|----------|
| OFDMA | 多用户并行 | 效率4倍 | 高密度环境 |
| MU-MIMO | 空间复用 | 并发3倍 | 多用户同时传输 |
| 1024-QAM | 高速传输 | 速率25% | 近距离高质量 |
| BSS着色 | 同频共存 | 干扰减少 | 密集部署 |
| TWT | 省电 | 续航延长 | IoT设备 |

**综合效果**：
```
场景：体育场有1000人同时上网
- Wi-Fi 5：卡顿、延迟高
- Wi-Fi 6：流畅、延迟低

原因：
- OFDMA：多人并行传输
- MU-MIMO：更多并发连接
- BSS着色：减少相邻AP干扰
```

> Wi-Fi 6就像从单车道升级到多车道高速公路，还加了智能交通管理系统