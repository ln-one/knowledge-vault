---
tags:
  - Knowledge/Computer-Network
created: 2025-11-18
author:
  - ln1
status: In Progress
---
## 1. 网络层概述
### 1.1 网络层的位置与功能
网络层位于传输层和数据链路层之间，是实现**端到端通信**的关键层次。

**核心功能：**
- **路由（Routing）**：选择数据报从源端到目的端的路径（控制面）
- **转发（Forwarding）**：将数据报从路由器的输入接口传送到正确的输出接口（数据面）

> 路由是"规划路线"，转发是"按路线行驶"。路由算法决定走哪条路，转发表决定从哪个口出去

**网络层功能存在于：**
- 每台主机（发送端封装、接收端解析）
- 每台路由器（检查首部、转发数据包）

### 1.2 网络层提供的两种服务

| 对比内容 | 无连接服务（数据报） | 面向连接服务（虚电路） |
|---------|-------------------|---------------------|
| 连接建立 | 不需要 | 必须要 |
| 地址 | 每个分组含完整源/目的地址 | 分组含短的虚电路号 |
| 路由选择 | 每个分组独立选择路由 | 分组沿建立好的路由发送 |
| 分组顺序 | 可能乱序到达 | 总是按序到达 |
| 可靠性保证 | 由主机（端系统）负责 | 由网络负责 |
| 路由器失效影响 | 可能丢失部分分组 | 所有经过的虚电路终止 |

> 类比：数据报像寄信（每封信独立投递），虚电路像打电话（先建立连接再通话）

**Internet采用数据报服务的原因：**
- 网络造价低，运行灵活
- 适应突发流量（如Web、Email）
- 端系统负责可靠性，网络只需"尽力而为"


## 2. IPv4协议
### 2.1 IPv4数据报格式
IPv4是互联网的核心协议，提供**无连接**的数据报服务。

**IPv4首部重要字段（需要记忆）：**

| 字段 | 长度 | 作用 |
|-----|------|-----|
| 版本 | 4bit | 协议版本号，IPv4值为4 |
| 首部长度 | 4bit | 首部长度（以4字节为单位） |
| 总长度 | 16bit | 整个IP报文长度，最大65535字节 |
| 标识 | 16bit | 分片后标识同一数据报的各分片 |
| 标志 | 3bit | DF=不允许分片，MF=后面还有分片 |
| 片偏移 | 13bit | 分片在原数据报中的相对位置（以8字节为单位） |
| TTL | 8bit | 生存时间，每经过一个路由器减1，为0时丢弃 |
| 协议 | 8bit | 上层协议类型（TCP=6, UDP=17, ICMP=1） |
| 首部校验和 | 16bit | 只校验首部，不包括数据 |
| 源地址 | 32bit | 发送方IP地址 |
| 目的地址 | 32bit | 接收方IP地址 |

> TTL的作用：防止数据报在网络中无限循环（路由错误时）

### 2.2 IP数据报分片
**为什么需要分片？**
- 不同链路的MTU（最大传输单元）不同
- 当数据报长度 > 链路MTU时，需要分片

**分片相关字段：**
- **标识**：同一数据报的所有分片具有相同的标识
- **MF标志**：1表示后面还有分片，0表示最后一个分片
- **片偏移**：该分片在原数据报中的位置（÷8）

> 例：3800字节数据，MTU=1500，分成3片：
> - 片1：偏移=0，MF=1，数据0-1399
> - 片2：偏移=175（1400÷8），MF=1，数据1400-2799  
> - 片3：偏移=350（2800÷8），MF=0，数据2800-3799

**IPv4分片特点：**
- 可在源端或中间路由器分片
- 只在目的端重组（不在途中重组）


### 2.3 IP地址
**IP地址**：网络上每台主机（或路由器）的每个接口分配的**全球唯一**的32位标识符。

#### 分类的IP地址
| 类别 | 首位 | 网络号位数 | 主机号位数 | 地址范围 |
|-----|------|-----------|-----------|---------|
| A类 | 0 | 8 | 24 | 1.0.0.0 ~ 126.255.255.255 |
| B类 | 10 | 16 | 16 | 128.0.0.0 ~ 191.255.255.255 |
| C类 | 110 | 24 | 8 | 192.0.0.0 ~ 223.255.255.255 |
| D类 | 1110 | - | - | 224.0.0.0 ~ 239.255.255.255（组播） |

> 快速判断：看第一个数字。1-126是A类，128-191是B类，192-223是C类

#### 特殊IP地址
| 地址 | 用途 |
|-----|------|
| 127.0.0.1 | 回环地址，测试本机TCP/IP协议栈 |
| 0.0.0.0 | 表示任意地址 |
| 255.255.255.255 | 本地广播（有限广播） |
| 主机号全0 | 网络地址（代表整个网络） |
| 主机号全1 | 定向广播地址 |

#### 子网划分
**目的**：将一个网络内部划分为多个子网，减少IP地址浪费

**三级IP地址结构**：网络号 + 子网号 + 主机号

**子网掩码**：32位，网络位和子网位置1，主机位置0
- 与IP地址进行AND运算得到**子网地址**

> 例：IP=172.16.2.160，掩码=255.255.255.192（/26）
> - 子网地址：172.16.2.128
> - 广播地址：172.16.2.191
> - 可用主机：172.16.2.129 ~ 172.16.2.190（共62个）

#### CIDR（无类域间路由）
**斜线记法**：IP地址/前缀长度，如 192.168.1.0/24

**最长前缀匹配**：路由器转发时，选择与目的IP匹配的**最长前缀**的路由

> 例：目的IP=200.23.24.170
> - 200.23.16.0/21 匹配21位
> - 200.23.24.0/24 匹配24位 ← 选择这条（更具体）


### 2.4 DHCP协议
**DHCP（动态主机配置协议）**：允许主机从服务器动态获取IP地址

**工作模式**：客户端/服务器模式，基于UDP（服务器67端口，客户端68端口）

**DHCP工作过程（四步）：**
```
1. DHCP Discover（发现）
   客户端广播：源IP=0.0.0.0，目的IP=255.255.255.255
   "有没有DHCP服务器？"

2. DHCP Offer（提供）
   服务器响应：提供可用的IP地址和配置信息
   "我可以给你这个IP地址"

3. DHCP Request（请求）
   客户端广播：选择一个服务器的offer
   "我要用你提供的IP地址"

4. DHCP ACK（确认）
   服务器确认：正式分配IP地址
   "好的，这个IP地址归你了"
```

> DHCP不仅分配IP地址，还提供：默认网关、DNS服务器、子网掩码等

### 2.5 ARP协议
**ARP（地址解析协议）**：根据IP地址获取对应的MAC地址

**为什么需要ARP？**
- IP地址是逻辑地址，用于网络层寻址
- MAC地址是物理地址，用于链路层实际传输
- 发送数据帧需要知道目的MAC地址

**ARP工作过程：**
```
1. A想发送数据给B，知道B的IP，不知道B的MAC
2. A检查本地ARP缓存，没有B的记录
3. A广播ARP请求："谁的IP是xxx？请告诉我你的MAC"
4. B收到请求，单播回复ARP响应："我的MAC是xxx"
5. A收到响应，缓存B的IP-MAC映射，发送数据
```

> ARP缓存有超时机制，过期后需要重新查询

**跨网络通信时的ARP：**
- A和B不在同一子网时，A需要先获取**默认网关**的MAC地址
- 数据帧的目的MAC是网关的MAC，但IP数据报的目的IP仍是B的IP


### 2.6 NAT协议
**NAT（网络地址转换）**：将私有IP地址转换为公有IP地址

**私有IP地址范围（需记忆）：**
- A类：10.0.0.0 ~ 10.255.255.255
- B类：172.16.0.0 ~ 172.31.255.255
- C类：192.168.0.0 ~ 192.168.255.255

**NAT工作原理：**
```
内网主机 10.0.0.1:3345 → 外网服务器 128.119.40.186:80

出方向：
  源地址 10.0.0.1:3345 → 138.76.29.7:5001（NAT转换）
  
入方向：
  目的地址 138.76.29.7:5001 → 10.0.0.1:3345（NAT还原）
```

**NAT转换表**：记录（内网IP:端口）↔（公网IP:端口）的映射

> NAT的优势：节省公网IP、隐藏内网结构、提供一定安全性
> NAT的问题：破坏端到端原则、不能处理IP头加密、P2P应用需要特殊处理

### 2.7 ICMP协议
**ICMP（互联网控制报文协议）**：用于报告差错和提供网络诊断信息

**ICMP报文类型：**

| 类型 | 功能 |
|-----|------|
| 0/8 | 回送应答/请求（ping使用） |
| 3 | 目的不可达 |
| 5 | 重定向 |
| 11 | TTL超时 |

**常用工具：**
- **ping**：使用ICMP回送请求/应答，测试连通性和往返时延
- **traceroute**：利用TTL递增和ICMP超时报文，追踪路径上的路由器

> traceroute原理：发送TTL=1,2,3...的UDP包，每个路由器返回ICMP超时，从而获知路径


## 3. 路由算法
### 3.1 路由算法概述
**路由算法的目标**：为每个目的网络找到最佳路径

**路由算法分类：**
- **静态路由**：手工配置，不随网络变化
- **动态路由**：根据网络状态自动调整

**两大类动态路由算法：** 

| 特性 | 距离向量（DV） | 链路状态（LS） |
|-----|---------------|---------------|
| 信息交换范围 | 只与邻居交换 | 全网洪泛 |
| 交换内容 | 到各目的的距离 | 本地链路状态 |
| 计算方式 | 分布式计算 | 各自独立计算 |
| 收敛速度 | 慢 | 快 |
| 典型协议 | RIP | OSPF |

### 3.2 距离向量路由（Bellman-Ford算法）
**核心思想**：每个路由器维护到所有目的的距离向量，周期性与邻居交换

**Bellman-Ford方程**：
$$D_x(y) = \min_v\{c(x,v) + D_v(y)\}$$

> 到目的y的最短距离 = 到邻居v的距离 + 邻居v到y的距离（取最小值）

**工作过程：**
1. 初始化：只知道直连网络，距离为0
2. 周期性向邻居发送自己的距离向量
3. 收到邻居的距离向量后，更新自己的路由表
4. 重复直到收敛

**计数到无穷问题**：
- "好消息传播快，坏消息传播慢"
- 当链路故障时，路由器可能反复增加距离值直到达到最大值（如16）

> 解决方法：水平分割、毒性反转、触发更新等


### 3.3 链路状态路由（Dijkstra算法）
**核心思想**：每个路由器了解全网拓扑，独立计算最短路径

**五个步骤：**
1. **发现邻居**：通过Hello报文了解邻居的网络地址
2. **测量代价**：设置到每个邻居的链路代价（带宽、延迟等）
3. **构造LSP**：构造链路状态分组（包含邻居列表和代价）
4. **洪泛LSP**：将LSP发送给所有路由器
5. **计算路径**：用Dijkstra算法计算到所有目的的最短路径

**Dijkstra算法示例：**
```
以节点u为起点，计算到所有节点的最短路径

步骤  集合N    D(v)  D(w)  D(x)  D(y)  D(z)
0     u        2     5     1     ∞     ∞
1     ux       2     4     -     2     ∞
2     uxy      2     3     -     -     4
3     uxyv     -     3     -     -     4
4     uxyvw    -     -     -     -     4
5     uxyvwz   -     -     -     -     -
```

> 每步选择距离最小的未加入节点，更新其邻居的距离

**链路状态 vs 距离向量：**
- LS更健壮：各自计算，一个路由器错误不影响其他
- LS收敛快：不存在计数到无穷问题
- LS开销大：需要洪泛LSP到全网

### 3.4 层次路由
**为什么需要层次路由？**
- 路由表太大，存储和查找困难
- 不同网络管理员希望自主管理

**自治系统（AS）**：一个管理机构控制下的网络，有全球唯一的AS号

**两级路由协议：**
- **IGP（内部网关协议）**：AS内部使用，如OSPF、RIP
- **EGP（外部网关协议）**：AS之间使用，如BGP

> 类比：IGP像城市内的道路规划，BGP像城市之间的高速公路连接


### 3.5 广播与组播路由
#### 广播路由
**广播**：源主机同时给所有目标发送同一数据包

**实现方法：**
1. **单独发送**：给每个主机单独发包（效率低）
2. **泛洪**：向所有出接口转发（可能产生广播风暴）
3. **逆向路径转发（RPF）**：只转发从最短路径来的包
4. **生成树**：沿着生成树转发，无环路、无冗余

#### 组播路由
**组播**：源主机给网络中的**一部分**目标用户发送数据

**组播地址**：D类地址（224.0.0.0 ~ 239.255.255.255）

**IGMP协议**：主机与路由器之间的组成员关系协议
- 路由器通过IGMP了解哪些主机属于哪个组播组

**组播路由方式：**
- **基于源点树**：为每个源建立独立的树（MOSPF、PIM-DM）
- **基于核心树**：多个源共享一棵树（PIM-SM）

> 组播的优势：一份数据，多人接收，节省带宽（如视频直播）

## 4. Internet路由协议
### 4.1 RIP协议
**RIP（路由信息协议）**：基于距离向量算法的IGP协议

**特点：**
- 使用**跳数**作为度量，最大15跳（16表示不可达）
- 每30秒周期性更新
- 基于UDP，端口520

**优点**：简单易实现
**缺点**：收敛慢、适用于小型网络


### 4.2 OSPF协议
**OSPF（开放最短路径优先）**：基于链路状态算法的IGP协议

**特点：**
- 使用Dijkstra算法计算最短路径
- 支持区域划分（层次结构）
- 基于IP协议，协议号89
- 支持多条等价路由、认证

**OSPF区域：**
- **主干区域（Area 0）**：所有其他区域必须与之相连
- **非主干区域**：通过ABR与主干区域连接

**路由器角色：**
- **IR（内部路由器）**：所有接口在同一区域
- **ABR（区域边界路由器）**：连接不同区域
- **ASBR（AS边界路由器）**：连接不同AS

**OSPF五种报文：**

| 报文类型 | 功能 |
|---------|------|
| Hello | 发现和维护邻居关系 |
| DD（数据库描述） | 描述本地LSDB摘要 |
| LSR（链路状态请求） | 请求缺少的LSA |
| LSU（链路状态更新） | 发送LSA详细信息 |
| LSACK（链路状态确认） | 确认收到LSU |

> OSPF适合大型网络：支持区域划分、收敛快、无环路

### 4.3 BGP协议
**BGP（边界网关协议）**：AS之间的路由协议（EGP）

**两种BGP会话：**
- **eBGP**：不同AS的路由器之间
- **iBGP**：同一AS内的路由器之间

**BGP路径属性：**
- **AS-PATH**：经过的AS序列（用于防环和选路）
- **NEXT-HOP**：下一跳IP地址

**BGP路由选择（优先级从高到低）：**
1. 本地偏好值最高
2. AS-PATH最短
3. NEXT-HOP最近
4. 其他标准...

> BGP是"策略路由"：不仅考虑最短路径，还考虑商业关系、政策等


### 4.4 MPLS（多协议标签交换）
**MPLS**：在IP网络上使用标签进行快速转发

**核心思想：**
- 在MPLS域入口给IP包加上标签
- 中间路由器根据标签转发（不查IP路由表）
- 在MPLS域出口去除标签

**优势：**
- 转发速度快（标签查找比IP查找快）
- 支持流量工程
- 支持VPN

> MPLS被称为"2.5层协议"：位于数据链路层和网络层之间

## 5. 路由器工作原理
### 5.1 路由器的两个核心功能
- **控制层（Control Plane）**：运行路由协议，维护路由表
- **数据层（Data Plane）**：根据转发表转发数据包

### 5.2 路由器转发过程
```
1. 从输入接口接收数据帧
2. 链路层解封装，提取IP数据报
3. 检查IP首部，获取目的IP地址
4. 查询转发表（最长前缀匹配）
5. TTL减1，重新计算首部校验和
6. 重新封装成数据帧
7. 从输出接口发送
```

> 转发过程中：IP地址不变，MAC地址改变，TTL减1

### 5.3 路由优先级
当存在多条到同一目的的路由时，按优先级选择：

| 路由类型 | 优先级（越小越优先） |
|---------|---------------------|
| 直连路由 | 0 |
| 静态路由 | 1 |
| eBGP | 20 |
| OSPF | 110 |
| RIP | 120 |
| iBGP | 200 |


## 6. 拥塞控制
### 6.1 拥塞的概念
**拥塞**：网络中数据包过多，导致传输延迟增加或丢包，网络吞吐量下降

**拥塞控制 vs 流量控制：**
- 流量控制：点对点，防止发送方淹没接收方
- 拥塞控制：全局性，防止过多数据注入网络

### 6.2 拥塞控制方法
- **流量感知路由**：绕开拥塞区域
- **准入控制**：限制新流量进入
- **流量调节**：通过抑制包通知发送方减速
- **负载丢弃**：主动丢弃部分数据包

**RED（随机早期检测）**：
- 维护队列的平均长度
- 当平均长度在阈值之间时，按概率丢弃新到达的包
- 提前预警，避免队列溢出

## 7. 服务质量（QoS）
### 7.1 QoS指标
- **带宽**：传输速率
- **时延**：端到端延迟
- **抖动**：时延的变化
- **丢包率**：丢失数据包的比例

### 7.2 流量整形
**漏桶算法**：
- 数据包进入桶中排队
- 以恒定速率从桶中流出
- 平滑突发流量

**令牌桶算法**：
- 以恒定速率产生令牌
- 发送数据包需要消耗令牌
- 允许一定程度的突发

> 漏桶输出恒定，令牌桶允许突发

### 7.3 综合服务与区分服务
- **综合服务（IntServ）**：基于RSVP预留资源，逐流处理
- **区分服务（DiffServ）**：按类别处理，更具扩展性


## 8. 三层交换与VPN
### 8.1 三层交换
**为什么需要三层交换？**
- 二层交换的广播问题限制网络规模
- VLAN隔离了广播但也隔离了正常通信
- 传统路由器转发效率低

**三层交换机**：融合了二层交换和三层路由功能
- 硬件实现IP转发，速度快
- 支持VLAN间路由
- 适合企业内网

**三层交换 vs 路由器：**

| 特性 | 三层交换机 | 路由器 |
|-----|-----------|--------|
| 转发速度 | 快（硬件） | 相对慢 |
| 端口类型 | 以太网为主 | 多种类型 |
| 适用场景 | 局域网 | 广域网互联 |

### 8.2 VPN（虚拟专用网）
**VPN**：利用公共网络建立专用网络连接

**核心技术：隧道技术**
- 将私有数据包封装在公网数据包中传输
- 提供加密和认证

**VPN类型：**
- **远程访问VPN**：移动用户接入企业网
- **站点到站点VPN**：连接企业分支机构

**隧道协议层次：**
- 二层隧道：L2TP、PPTP
- 三层隧道：IPSec、GRE
- 传输层隧道：SSL/TLS

> VPN的本质：在不安全的公网上建立安全的"专线"


## 9. IPv6技术
### 9.1 IPv6概述
**为什么需要IPv6？**
- IPv4地址耗尽（32位，约43亿个地址）
- IPv6地址128位，约3×10^38个地址

**IPv6地址表示：**
- 冒分十六进制：`2001:0DA8:0000:0000:200C:0000:0000:00A5`
- 简化：前导0可省略，连续的0可用`::`表示（只能用一次）
- 简化后：`2001:DA8::200C:0:0:A5`

### 9.2 IPv6首部
**IPv6首部固定40字节**，比IPv4更简洁：

| 字段 | 长度 | 作用 |
|-----|------|-----|
| 版本 | 4bit | 值为6 |
| 流量类型 | 8bit | 区分服务类别 |
| 流标签 | 20bit | 标识同一数据流 |
| 有效载荷长度 | 16bit | 扩展头+数据的长度 |
| 下一个首部 | 8bit | 指示扩展头或上层协议 |
| 跳数限制 | 8bit | 类似IPv4的TTL |
| 源地址 | 128bit | |
| 目的地址 | 128bit | |

**IPv6改进：**
- 去除首部校验和（提高转发速度）
- 去除分片字段（移至扩展头，只在源端分片）
- 选项字段移至扩展头

### 9.3 IPv6地址类型
- **单播地址**：一对一通信
- **组播地址**：一对多通信（FF00::/8）
- **任播地址**：一对最近一个通信
- **链路本地地址**：FE80::/10，仅本地链路使用

### 9.4 IPv4到IPv6过渡
**三种过渡技术：**

1. **双栈技术**：设备同时支持IPv4和IPv6
2. **隧道技术**：将IPv6包封装在IPv4包中传输
3. **翻译技术**：IPv4和IPv6地址/报头相互转换

> 过渡是渐进的：目前IPv4和IPv6长期共存


## 10. 重点概念速记卡

### 协议对比速记
```
┌─────────────────────────────────────────────────────┐
│  RIP vs OSPF vs BGP                                 │
├─────────────────────────────────────────────────────┤
│  RIP:  距离向量 | 跳数 | UDP 520 | 小型网络        │
│  OSPF: 链路状态 | 带宽 | IP 89   | 大型网络/区域   │
│  BGP:  路径向量 | 策略 | TCP 179 | AS之间          │
└─────────────────────────────────────────────────────┘
```

### IP地址速记
```
┌─────────────────────────────────────────────────────┐
│  私有地址（必背）                                    │
├─────────────────────────────────────────────────────┤
│  A类: 10.0.0.0/8      (1个A类网络)                  │
│  B类: 172.16.0.0/12   (16个B类网络)                 │
│  C类: 192.168.0.0/16  (256个C类网络)                │
└─────────────────────────────────────────────────────┘
```

### 常用端口/协议号
```
┌─────────────────────────────────────────────────────┐
│  协议      端口/协议号                               │
├─────────────────────────────────────────────────────┤
│  DHCP     UDP 67(服务器) / 68(客户端)               │
│  RIP      UDP 520                                   │
│  BGP      TCP 179                                   │
│  OSPF     IP协议号 89                               │
│  ICMP     IP协议号 1                                │
│  TCP      IP协议号 6                                │
│  UDP      IP协议号 17                               │
└─────────────────────────────────────────────────────┘
```

### 关键公式
```
子网可用主机数 = 2^(主机位数) - 2

片偏移值 = 该片起始字节位置 ÷ 8

CIDR地址块大小 = 2^(32-前缀长度)
```

### 易混淆概念
| 概念A | 概念B | 区别 |
|------|------|------|
| 路由 | 转发 | 路由是选路（控制面），转发是执行（数据面） |
| 数据报 | 虚电路 | 数据报无连接，虚电路面向连接 |
| ARP | RARP | ARP是IP→MAC，RARP是MAC→IP |
| 广播 | 组播 | 广播是发给所有人，组播是发给特定组 |
| NAT | PAT | NAT转换IP，PAT还转换端口（NAPT） |

---
> 💡 学习建议：
> 1. 先理解网络层的核心功能：路由和转发
> 2. 重点掌握IP地址、子网划分、CIDR
> 3. 理解两类路由算法的思想差异
> 4. 熟悉常见协议的工作过程（DHCP、ARP、ICMP）
> 5. 考试前重点复习协议对比表和端口号
