## CH1: 引言

> 重点关注计算题和度量单位

### 最最最最最最重要的：**1Byte = 8 bits**

- 物理媒体的分类：**引导型介质** 和 **非引导型介质**
- 网络核心的两大功能分别是什么：**1.路由** **2.转发**
- **电路交换**和**分组交换**和**报文交换**![[Pasted image 20260102183612.png]]
- 学了计算机网络的分层架构不展开，我们在这里假设所有人都应该了解计算机网络的分层架构。
- OSI七层模型填空题：**应用层**、**表示层**、**会话层**、**传输层**、**网络层**、**数据链路层**、**物理层**
- TCP/IP四层模型：**应用层**、**传输层**、**互联网层**、**网络接口层**
- ![[Pasted image 20260102184432.png]]
![[Pasted image 20260103205737.png]]

---

### 重点：计算机网络度量单位

[[Chapter-1-计算机网络和因特网#4.分组交换网中的时延、丢包和吞吐量]]

- 比特率
- 带宽
- 包转发率(PPS)
- **时延(Delay)**:![[Pasted image 20260102184837.png]] ![[Pasted image 20260102184916.png]]

#### 时延的四种类型

1. **处理时延**：检查分组首部、决定转发方向
2. **排队时延**：在缓冲区等待传输
3. **传输时延** = L / R（L是分组长度，R是链路速率）
4. **传播时延** = d / v（d是距离，v是传播速度）

- 往返时延RTT(Round-Trip Time)：从发送方发送数据开始，到发送方收到来自接收方的确认，经历的总时间。
	- 例题：ping命令获取的时间是什么：**往返时延RTT**
- 时延带宽积：![[Pasted image 20260102190519.png]]

---

### 例题：三种交换方式时延计算

假设需在两台计算机间经两个中间节点传送 $100 \times 10^6$ 字节的文件，假定：
- a) 各跳的通信线路的通信速率皆为 $8 \times 10^3$ bps；
- b) 不考虑中间节点存储转发等处理时间和排队时间；
- c) 每一段线路的传播时延均为10ms。

方案甲：采用电路交换技术传输（假设电路已经建好）。
方案乙：将整个文件逐级存储转发（报文交换），假设报文头为10字节。
方案丙：将文件分为1000字节长的帧再进行逐级存储转发，假定帧头和帧尾的开销各为10字节（分组交换）。

**问题**：
(1) 与分组交换相比，电路交换具有哪些优点？
(2) 请描述计算机网络若采用电路交换技术可能出现的问题。
(3) 方案甲传送此文件所需时间。
(4) 方案乙传送此文件所需时间。
(5) 方案丙传送此文件所需时间。

#### 答案

**(1) 电路交换的优点**：
- 传输时延固定，适合实时通信（如电话）
- 数据按序到达，无需重新排序
- 一旦建立连接，传输速率有保障
- 无需在每个分组中携带地址信息

**(2) 电路交换的问题**：
- 建立连接需要时间开销
- 资源预先分配，即使空闲也被占用，利用率低
- 通信双方必须同时在线
- 不适合突发性数据传输
- 线路故障会导致通信中断

**(3) 方案甲（电路交换）**：

$$数据量 = 100 \times 10^6 \times 8 = 8 \times 10^8 \ bit$$

$$传输时延 = \frac{8 \times 10^8}{8 \times 10^3} = 10^5 = 100000 \ s$$

$$传播时延 = 3 \times 0.01 = 0.03 \ s$$

$$总时延 = 100000 + 0.03 = 100000.03 \ s$$

**答：100000.03 秒**

**(4) 方案乙（报文交换）**：

$$报文总长 = (100 \times 10^6 + 10) \times 8 = 800000080 \ bit$$

$$每跳传输时延 = \frac{800000080}{8000} = 100000.01 \ s$$

需要3跳存储转发（源→节点1→节点2→目的）

$$总传输时延 = 3 \times 100000.01 = 300000.03 \ s$$

$$总时延 = 300000.03 + 0.03 = 300000.06 \ s$$

**答：300000.06 秒**

**(5) 方案丙（分组交换）**：

$$每个分组 = (1000 + 10 + 10) \times 8 = 8160 \ bit$$

$$分组数 = \frac{100 \times 10^6}{1000} = 100000 \ 个$$

$$每个分组传输时延 = \frac{8160}{8000} = 1.02 \ s$$

采用流水线方式：
- 第1个分组经过3跳到达目的地：$3 \times 1.02 = 3.06 \ s$
- 后续99999个分组每隔1.02s到达一个：$99999 \times 1.02 = 101998.98 \ s$

$$总时延 = 3.06 + 101998.98 + 0.03 = 102002.07 \ s$$

**答：102002.07 秒**

**结论**：电路交换(100000.03s) < 分组交换(102002.07s) < 报文交换(300000.06s)

---

### 常用单位换算

```
1 Byte = 8 bit
1 KB = 1024 Byte
1 MB = 1024 KB
1 Gbps = 10^9 bps
1 Mbps = 10^6 bps
1 kbps = 10^3 bps
1 ms = 10^-3 s
```

---

## CH2: 物理层

> 记忆背诵偏多

![[Pasted image 20260103212107.png]]

### 物理层基本概念

1. 物理层的四个特性：**机械特性**、**电气特性**、**功能特性**、**过程特性**
2. **消息**和**信息**：消息是信息的载体，消息中可能含有信息
3. **数据**是原始表达，数据是消息的一种表示形式。信号是消息的载体。数据可以分为**模拟数据**和**数字数据**

### 传输方式分类

1. **并行传输**和**串行传输**
2. **点到点传输**和**点到多点传输**![[Pasted image 20260103214025.png]]
3. **单工**、**半双工**和**全双工**：半双工和全双工的区别在于半双工不能同时进行传输![[Pasted image 20260103214127.png]]
4. **异步传输**和**同步传输**：区别在于异步传输的发送器和接收器的时钟是不同步的，而同步传输两者的时钟是同步的
5. **基带传输**和**频带传输**：按照传输系统在传输数据信号过程中是否搬移其频谱来区分，基带一般用低电平表示"0"，高电平表示"1"

### 数据编码技术

![[Pasted image 20260103214609.png]]

### 信道容量定理

#### 奈奎斯特定理

$$C = 2H \log_2 L$$

- H：低通信道的带宽(Hz)
- L：某给定时刻数字信号可能取的离散值个数(码元波形状态)
- C：该信道的最大数据传输率/信息传输速率(b/s)

![[Pasted image 20260103220915.png]]

#### 香农定理

$$C = H \log_2(1+S/N)$$

- H：带宽
- S/N：信噪比。信噪比常用**分贝**为计量单位，分贝数 $= 10 \log_{10}(S/N)$。如30dB对应1000:1

![[Pasted image 20260103221524.png]]

#### 比特率与波特率的关系

$$B = C \log_2 L$$

![[Pasted image 20260103222659.png]]
![[Pasted image 20260103222755.png]]
![[Pasted image 20260103222811.png]]
![[Pasted image 20260103223144.png]]

### 数字通信与模拟通信比较

- **优点**：抗干扰性强，保密性好，设备易于集成，便于计算机处理等
- **缺点**：占用较多的带宽，信道利用率低

### 频带利用率

![[Pasted image 20260103223442.png]]

### 复用技术

#### 1. 频分复用（FDM）

![[Pasted image 20260103224159.png]]

#### 2. 时分复用（TDM）

![[Pasted image 20260103224228.png]]

#### 3. 波分复用（WDM）

#### 4. 码分复用（CDMA）

扩频技术![[Pasted image 20260103224501.png]]

每个站分配的码片序列不仅必须**各不相同**，而且必须**相互正交**：
- 两个不同站的码片序列正交，就是向量S和T的规格化内积等于0
- 任何一个码片向量和该码片向量自己的规格化内积都是1
- 一个码片向量和该码片反码的向量的规格化内积值是–1

![[Pasted image 20260103224743.png]]

#### 5. 正交频分复用（OFDM）

#### 6. 空分复用（SDM）

---

## CH3: 数据链路层

### 数据链路层的三个功能

1. **成帧(Framing)**：数据链路层将比特流划分为"**帧**"
2. **差错控制(Error Control)**
3. **流量控制(Flow Control)**

### 成帧(Framing)的三种方式

#### 1. 字节计数法(Byte count)

![[Pasted image 20260104141254.png]]
![[Pasted image 20260104141304.png]]

#### 2. 带字节填充的定界符法

![[Pasted image 20260104141812.png]]
![[Pasted image 20260104141839.png]]

**例题**：某通信协议采用字符填充的成帧技术，其中帧的开始和结束标志均为特殊字符"DLE STX"和"DLE ETX"。为了避免数据内容中包含的"DLE"字符被误识别为帧边界，当"DLE"出现在数据中时，系统会在它后面添加一个额外的"DLE"作为转义符。假设要传输的数据内容为："ABC DLE FG DLE DLE HI"，请写出经过字符填充后的完整帧内容。

![[Pasted image 20260104142012.png]]

**答案**：加上帧开始和结束：`DLE STX ABC DLE DLE FG DLE DLE DLE DLE HI DLE ETX`

#### 3. 带比特填充的定界符法

![[Pasted image 20260104143145.png]]
![[Pasted image 20260104143211.png]]
![[Pasted image 20260104143224.png]]

**例题**：小明正在开发一套数据传输系统，该系统需要将数据封装成帧并传输。为了确保数据传输的可靠性和准确性，他选择了比特填充的成帧方法。假设帧的定界符是特殊的比特模式"01111110"，而在数据中每当出现连续的五个"1"时，系统会自动在后面插入一个"0"来防止定界符的误识别。小明需要传输以下数据比特流："0111111011101111111110"。在使用比特填充技术后，最终传输的比特流是什么？

![[Pasted image 20260104143449.png]]

#### 4. 物理层编码违例

意思就是选择的定界符不会在数据部分出现。

---

### 差错控制

一般两种策略，都是通过增加冗余信息来完成：
- **检错码**：只能判断是否发生错误，但不能判断哪位发生错误
- **纠错码**：可以纠正错误

#### 基本概念

- **码字(code word)**：一个包含m个数据位和r个检验位的n位单元。描述为(n,m)码，n=m+r
- **码率(code rate)**：码字中不含冗余部分所占的比例，可以用m/n表示
- **海明距离(Hamming distance)**：两个码字之间不同对应比特的数目，即**两个等长字符串/比特串中，对应位置不相同的个数**

![[Pasted image 20260104151614.png]]
![[Pasted image 20260104151826.png]]

#### 检错码

> 一般来说相较于纠错码，检错码会考的比较多，因为比较简单。

##### 奇偶校验

- **偶校验**：保证**数据位**的**1**的个数为偶数个
- **奇校验**：保证**数据位**的**1**的个数为奇数个

##### 校验和

![[Pasted image 20260104153543.png]]

**例题**：小李需要传输一组比特数据 10110011、11010101 和 00111100，他使用包含进位的逐位相加法来计算校验和。传输后的总和（包含进位）取反应为 11111111。请计算出该数据组的校验和。

![[Pasted image 20260104153741.png]]

> 注意：高位如果有进位，需要加到结果低八位。

##### CRC检验码

![[Pasted image 20260104155432.png]]

> 提示：不要硬看，对照着下面的例题看

![[Pasted image 20260104155454.png]]
![[Pasted image 20260104155759.png]]
![[Pasted image 20260104155809.png]]
![[Pasted image 20260104155816.png]]

#### 纠错码

> 其实可能不太会考，因为偏难，如果你想要高分，可以看一看，如果只是想及格，可以跳过

##### 海明码

![[Pasted image 20260104160537.png]]
![[Pasted image 20260104160303.png]]
![[Pasted image 20260104160345.png]]
![[Pasted image 20260104160417.png]]
![[Pasted image 20260104161602.png]]

> P**1** 校验所有"位置编号二进制最低位为1"的比特，但要排除B**1**本身（因为它就是P**1**），比如说B3是001**1**，右边数第**1**位为1，又比如说B5是0101，从右边数第1位也为1。那么P2同理也是这样的。B3是0011，从右边数第2位为1。

##### RS码

太难了，应该不考，如果不放心，看下例题。**Reed–Solomon码是符号级纠错码，最多可纠正** $t=\left\lfloor\frac{n-k}{2}\right\rfloor$ **个符号错误，特别擅长突发错误。**

**例题**：RS(255,223)码最多能纠正多少个符号错误？

**答案**：$t=\frac{255-223}{2}=16$ 个符号错误

---

### 基本的数据链路层协议

**三个关键假设**：**分层进程独立假设**、**提供可靠服务假设**、**只处理通信错误假设**

#### 乌托邦式单工协议

- **单工协议**（数据单向传输）
- **完美信道**（帧不会丢失或受损）
- **始终就绪**（发送方/接收方始终处于就绪状态）
- **瞬间完成**（发送方/接收方能够生成/处理无穷多的数据）

#### 无错信道上的停等式协议

- **半双工协议**
- **完美信道**
- 发送方以高于接收方能处理到达帧的速度发送帧

![[Pasted image 20260104171018.png]]

#### 有错信道上的单工停等式协议

帧可能会损坏或丢失。

![[Pasted image 20260104172940.png]]

> 以上内容可以结合着传输层的TCP协议来理解，尽管我假设你还不知道TCP是什么。

---

### 滑动窗口协议

停止-等待机制降低了**信道利用率**，所以我们要用滑动窗口协议来解决这个问题。

**窗口机制**：发送方和接收方都具有一定容量的缓冲区(即窗口)，发送端在收到确认之前可以发送多个帧。

- 循环**重复使用**有限的帧序号
- **流量控制**：
	- 发送窗口 $W_T$：表示在收到对方确认的信息之前，可以连续发出的最多数据帧数
	- 接收窗口 $W_R$：可以连续接收的最多数据帧数
- **累计确认**：**不必**对收到的分组逐个确认

![[Pasted image 20260104173941.png]]

> 说白了就是序号反复用，然后到最大数回到最小数。

#### 回退N协议(GBN)

- **出错全部重发**：当接收端收到一个**出错帧或者乱序帧**时，**丢弃所有**的后续帧，并且不为这些帧发送确认。发送端**超时**后，**重传所有**未被确认的帧
- 使用**接收窗口($W_R$)为1**的情况，即**只能按顺序**接收帧
- **累计确认**：
	> GBN的ACK表示"我已经收到哪一帧"，
	> TCP的ACK表示"我接下来期望哪一个字节"。（如果你是复习的话，预习请忽略）
- **缺点**：按序接收，出错后即便有正确帧到达也丢弃重传（就是有点浪费后面传来的那些正确的帧，因为一出错就全部重发）

![[Pasted image 20260104175325.png]]

#### 选择重传协议(SR)

若发送方发出连续的若干帧后，收到对其中某一帧的否认帧，或某一帧的定时器超时，**则只重传该出错帧或计时器超时的数据帧**。

> 选择重传更精确：只重传真正出错的帧，但实现复杂度更高

**适用场景**：
- 对应**接收窗口($W_R$)大于1**的情况，即暂存接收窗口中序号在出错帧之后的数据帧

**基本原理**：
- 在发送过程中，如果一个数据帧计时器超时，就认为该帧丢失或者被破坏
- 接收端只把出错的帧丢弃，其后面的数据帧保存在缓存中，并向发送端回复NAK
- 发送端接收到NAK时，只重传出错的帧
- 如果落在窗口内的帧从未接收过，那么存储起来，等比它序列号小的所有帧都正确接收后，按次序交付给网络层
- 接收端收到的数据包的顺序可能和发送的数据包顺序不一样，因此在数据包里必须含有顺序号来帮助接收端进行排序

**滑动窗口长度**：
- 发送窗口的尺寸：$W_T \leq 2^{n-1}$，发送窗口应等于或小于序号空间的一半

> 选择重传的窗口限制更严格：最多只能是序号空间的一半

**实现要点**：
- SR是**给每一个PDU设置定时器**，发送端**只重传出错PDU**

> 选择重传需要为每个帧单独设置定时器，增加了实现复杂度

---

### PPP协议与PPPoE

#### PPP协议要点

- PPP是一种**点对点的数据链路层协议**，只负责**检错不负责纠错**，不支持多点连接，支持全双工
- 通过**LCP**建立、配置和测试链路，通过**NCP**支持多种网络层协议（如IP）
- PPP帧通过**字节填充**（异步）或**比特填充**（同步）避免标志字段冲突

#### PPPoE要点

- PPPoE将**PPP封装在以太网之上**，结合了以太网的低成本与PPP的认证、计费和访问控制能力
- 采用**Client/Server模型**，通常由接入服务器提供服务
- 工作分为**Discovery（发现）、Session（会话）、Terminate（终止）**三个阶段，是宽带接入的常用技术

> 这俩不是重点。其实我也不喜欢看代码

## CH4:介质访问子层
![[Pasted image 20260104200656.png]]
常见的局域网拓扑：**总线拓扑**、**星型拓扑**、**环形拓扑**。共同点：**共享一根信道**。
![[Pasted image 20260104200923.png]]
#### ALOHA协议
##### 纯ALOHA协议
- **工作原理**：想发就发！（任性）
- **特点**：冲突不可避免，随时可能冲突，冲突的帧完全破坏
- **冲突危险期**：2D（D为单向传播延迟）
- **吞吐量**：S = Ge^(-2G)，最大吞吐率约18.4%（G=0.5时）

> 冲突危险期为2D是因为：A发送时，最远的B在D时间后才能检测到，如果B在A发送后D时间内发送，会在A处产生冲突

##### 分隙ALOHA协议
- **改进**：把时间分成时隙，帧的发送必须在时隙的起点
- **冲突危险期**：D（减半）
- **吞吐量**：S = Ge^(-G)，最大吞吐率约36.8%（G=1时）
- **优势**：是纯ALOHA的两倍

> 时隙同步使得冲突只能发生在时隙开始时刻，大大减少了冲突概率

#### CSMA协议（载波侦听多路访问）
- **核心思想**："先听后发"（不再任性，变得礼貌）

##### 非持续式CSMA
- **特点**：介质空闲则发送，介质忙则等待随机时间
- **优点**：减少再次碰撞可能性
- **缺点**：等待时间内介质空闲是浪费

##### 1-持续式CSMA
- **特点**：介质空闲立即发送，介质忙持续侦听
- **优点**：延迟时间少
- **缺点**：多个站等待时一定会发生冲突

##### p-持续式CSMA
- **特点**：介质空闲时以概率p发送，以(1-p)概率延迟
- **注意**：1-持续式是p-持续式的特例

#### CSMA/CD协议（重点）

- **全称**：Carrier Sense Multiple Access with Collision Detection
- **核心原理**："**先听后发、边发边听、冲突停发、随机重发**"
- **冲突窗口** = 2τ（信号一来一回的时间）
- **最小帧长 = 64字节**：保证发完帧之前能检测到冲突
- **最大帧长 = 1518字节**：防止霸占信道
- **Jam信号**：撞了就发这个，让大家都知道
- **二进制指数退避**：撞的次数越多，等的范围越大

> 简单记：听→发→听→撞了停→喊一声→随机等→再试

**为什么不能用于无线？** 自己发的信号太强，听不到别人的弱信号，没法"边发边听"。

##### 工作流程

1. **先听后发**：发送前先侦听信道，空闲才发送
2. **边发边听**：发送过程中持续检测冲突
3. **冲突停发**：一旦检测到冲突，立即停止发送
4. **发送Jam信号**：发送32-48bit的强化冲突信号，确保所有站点都能检测到冲突
5. **随机重发**：等待随机时间后重新尝试（二进制指数退避算法）
### 受控访问协议（无冲突）

#### 位图协议（预留协议）
- **过程**：竞争期举手示意 → 传输期按序发送
- **信道利用率**：低负荷d/(d+N)，高负荷d/(d+1)

> 类似会议发言，先举手报名，再按顺序发言，避免了冲突但增加了开销

#### 令牌传递
- **原理**：令牌=发送权限，获得令牌才能发送
- **缺点**：令牌的维护代价

> 令牌环网络的经典协议，令牌丢失或重复都会导致网络故障

#### 二进制倒计数协议
- **特点**：高序号站点优先获得发送权
- **信道利用率**：d/(d+log₂N)

### 有限竞争协议
- **代表**：自适应树搜索协议
- **思想**：结合随机访问和受控访问的优势

### 经典以太网：
- 最高速率**10Mbps**。
- MAC帧中的源地址和目的地址长度均为**6字节**。
- 最小帧长：**64（46+18）Bytes** 最长帧长：**1518（1500+18）Bytes**（MTU：1500Bytes）
### 交换式以太网：
**集线器（HUB）**：
- 工作在**物理层**，所有端口内部连通
- 逻辑上等同于单根总线
- 所有站都在**同一个冲突域**，必须使用CSMA/CD
- 不能增加容量，限制网络可扩展性
> 记住：Hub不隔离冲突域，Bridge/Switch隔离冲突域

**交换机（Switch）**：
- 工作在**数据链路层**，检查MAC帧目的地址进行转发
- **每个端口独立的冲突域**
- 可以实现**并行**传输


> 交换机的出现是以太网发展的重要里程碑，从共享介质变为交换介质

![[Pasted image 20260104214949.png]]
**答案：2个冲突域**
**解析**：
- **Hub（集线器）**：不隔离冲突域，所有连接到Hub的网段属于**同一个冲突域**
- **Bridge（网桥）**：**隔离冲突域**，网桥的每个端口是一个独立的冲突域
**分析这个图**：
1. Hub连接了：网段1、网段2、网段3 → 这三个网段是**同一个冲突域**（冲突域1）
2. Bridge隔离了网段3和网段4 → 网段4是**独立的冲突域**（冲突域2）
所以：
- **冲突域1**：网段1 + 网段2 + 网段3（通过Hub连接）
- **冲突域2**：网段4（被Bridge隔离）
**总共2个冲突域**
**网桥**：网桥为什么是透明的？
含义：主机完全感知不到网桥的存在，不需要任何配置，插上就能用。
原因：![[Pasted image 20260104215607.png]]

#### 链路层交换机：
交换模式：**存储转发模式**、**直通模式**、**无碎片模式**
##### 1.存储转发模式（Store and Forward)
- 特点：转发前必须接收**整个帧**，执行CRC校验
- 缺点：延迟大
- 优点：不转发出错帧、支持非对称交换

> 最安全的转发方式，现代交换机的主流模式
##### 2.直通交换（Cut-through）
- 特点：一旦接收到**帧的目的地址**，就开始转发
- 缺点：可能转发错误帧，不支持非对称交换
- 优点：延迟小，可以边入边出

> 追求极低延迟的应用场景使用，如高频交易系统
##### 3.无碎片交换（Fragment-free）
- 特点：接收到**帧的前64字节**，即开始转发
- 缺点：仍可能转发错误帧，不支持非对称交换。
- 优点：过滤了冲突碎片，延迟中等

> 折中方案：64字节能过滤掉大部分冲突产生的碎片帧


![[Pasted image 20260104220720.png]]
> 直接选C

### 生成树协议：
>感觉很可能会考，考个大题什么的，或者一个简答，如果你是出卷人，你会怎么想

为什么需要？因为存在问题。
#### 物理环路的问题
1. **广播风暴**：广播帧无限循环，消耗网络资源
2. **重复帧**：目的设备收到重复的帧副本
3. **MAC地址表不稳定**：同一MAC地址对应端口不断变化
> STP的核心思想：在有冗余链路的网络中构建一棵无环的生成树

#### 三个选举过程

**1. 选举根桥（Root Bridge）**
- **规则**：桥ID最小的成为根桥
- **桥ID组成**：优先级（2字节）+ MAC地址（6字节）
- **比较方法**：
  - 先比较**优先级**，**数值小**的优先
  - 优先级**相同**，比较**MAC地址**，数值**小**的优先
- **举例**：
  - 交换机A：优先级32768，MAC 00-0A-00-11-11-11
  - 交换机B：优先级24576，MAC 00-0A-00-33-33-33
  - 结果：B成为根桥（优先级更小）

![[Pasted image 20251104113423.png]]

> 根桥就像树的根部，是整个生成树的中心，所有路径计算都以它为基准

**2. 选举根端口（Root Port）**
- **规则**：每个非根桥选出到根桥开销最小的端口
- **什么是根路径开销？**
  - 根桥的根路径开销 = 0（它就是根）
  - 非根桥的根路径开销 = 到根桥路径上所有链路开销之和
- **选举步骤**：
  1. 计算每个端口到根桥的路径开销
  2. 选择开销最小的端口作为根端口
  3. 如果**开销相同**，选择**端口ID最小**的

- **举例**：
  ```
  交换机C有两个端口连接到根桥：
  - F0/1：经过一条100Mbps链路，开销 = 19
  - F0/2：经过两条100Mbps链路，开销 = 19+19 = 38
  结果：F0/1成为根端口（开销更小）
  ```

![[Pasted image 20251104114143.png]]

> 根端口是非根桥通往根桥的"最佳路径"，每个非根桥只有一个根端口

**3. 选举指定端口（Designated Port）**
- **规则**：每个网段选出根路径开销最小的端口
- **什么是网段？**
  - 两个交换机之间的连接就是一个网段
- **选举步骤**：
  1. 对于每个网段，比较连接到它的所有端口
  2. 选择根路径开销最小的端口
  3. 如果开销相同，选择所属交换机桥ID小的端口
  4. 如果桥ID也相同，选择端口ID小的

- **举例**：
  ```
  网段X连接交换机A和B：
  - A的端口：到根桥开销 = 19
  - B的端口：到根桥开销 = 38
  结果：A的端口成为指定端口（开销更小）
  ```

![[Pasted image 20251104114612.png]]

> 指定端口负责该网段的数据转发，每个网段只有一个指定端口

**端口角色总结**：
- **根端口**：非根桥通往根桥的最佳路径（转发状态）
- **指定端口**：负责网段数据转发的端口（转发状态）
- **阻塞端口**：既不是根端口也不是指定端口（阻塞状态，防止环路）
> 选举顺序很重要：先选根桥，再选根端口，最后选指定端口

RSTP：Rapid Spanning Tree Protocol：即**更快**的生成树。

### VLAN
> 考过计网实验了，我在这里假设你比较懂虚拟局域网。

VLAN的划分方式：基于**端口**、**MAC地址**、**协议**、**子网**

>以下内容懒得手敲了，如果你时间不够，可以直接跳过看第五章
### 无线局域网（WLAN）

#### 无线环境的挑战

**1. 冲突检测困难**
- **问题**：无线网卡在发送时无法同时接收
- **原因**：
  - 发送功率很大（如100mW）
  - 接收到的信号很弱（可能只有0.001mW）
  - 发送信号会"淹没"接收信号
  
- **对比有线网络**：
  - 有线：可以边发边听（CSMA/CD）
  - 无线：只能发送完再听（CSMA/CA）

> 就像你在用大喇叭喊话时，听不到别人的小声说话

**2. 隐藏终端问题（Hidden Terminal Problem）**
- **场景描述**：
  ```
  A ←→ B ←→ C
  
  - A和C都在B的通信范围内
  - 但A和C互相不在对方的通信范围内
  - A和C都想给B发送数据
  ```

- **问题过程**：
  1. A侦听信道，发现空闲（因为听不到C）
  2. C也侦听信道，发现空闲（因为听不到A）
  3. A和C同时向B发送数据
  4. 在B处发生冲突！
  5. 但A和C都不知道发生了冲突

- **后果**：
  - 数据在接收端B处冲突
  - 发送端A和C无法检测到冲突
  - 导致数据丢失

> 就像两个人在房间两端同时跟中间的人说话，中间的人听不清，但两端的人互相听不到对方

**3. 暴露终端问题（Exposed Terminal Problem）**
- **场景描述**：
  ```
  A ←→ B ←→ C ←→ D
  
  - B正在向A发送数据
  - C想向D发送数据
  ```

- **问题过程**：
  1. B正在向A发送数据
  2. C侦听信道，发现信道忙（听到了B的发送）
  3. C认为不能发送，等待
  4. 但实际上C→D的传输不会干扰B→A的传输
  5. C的等待是不必要的，浪费了信道资源

- **后果**：
  - 降低了网络吞吐量
  - 信道利用率下降

> 就像你在房间一端打电话，另一端的人以为会干扰你，其实不会

**三个问题的对比**：

| 问题 | 原因 | 后果 | 解决方案 |
|------|------|------|----------|
| 冲突检测困难 | 发送时无法接收 | 无法及时发现冲突 | 使用确认机制 |
| 隐藏终端 | 发送端互相听不到 | 在接收端冲突 | RTS/CTS机制 |
| 暴露终端 | 误判信道忙 | 降低吞吐量 | 智能退避算法 |

> 无线环境比有线环境复杂得多：信号衰减、多径传播、移动性等都是挑战

#### CSMA/CA工作机制

**为什么不用 CSMA/CD？**
- 无线网卡发送时功率很大，接收信号很弱
- 自己发的信号会"淹没"别人的信号，没法"边发边听"
- 所以无线网络只能**避免冲突**，而不是**检测冲突**

**核心思想**：Collision Avoidance（冲突避免）—— 发之前尽量确保不会撞

**工作流程（大白话版）**：

```
想发数据的站点A：

1. 先听信道 → 空闲吗？
   ├─ 空闲：再等一个 DIFS 时间，还空闲就发！
   └─ 忙：乖乖等着，等别人发完

2. 等别人发完后：
   - 不能立刻发（大家都等着呢，一起发就撞了）
   - 进入"退避"：随机选一个数，倒计时

3. 退避倒计时：
   - 信道空闲 → 倒计时继续
   - 信道变忙 → 暂停倒计时，等信道空闲再继续
   - 倒计时到0 → 可以发了！

4. 发完数据后：
   - 等对方回 ACK（确认收到）
   - 没收到 ACK → 认为冲突了，重传
```

**二进制指数退避**：
- 第1次冲突：从 [0, 1] 随机选
- 第2次冲突：从 [0, 3] 随机选
- 第3次冲突：从 [0, 7] 随机选
- 撞得越多，等的范围越大，减少再次冲突的概率

**简单记忆**：先听 → 空闲等一下 → 随机退避 → 发送 → 等ACK

#### 帧间隙（IFS）—— 用等待时间区分优先级

不同类型的帧等待时间不同，等得短的优先级高：

| 类型 | 等待时间 | 优先级 | 用途 |
|------|----------|--------|------|
| SIFS | 最短 | 最高 | ACK、CTS 等控制帧 |
| PIFS | 中等 | 中等 | 轮询服务 |
| DIFS | 最长 | 最低 | 普通数据帧 |

> 为什么 ACK 优先级最高？因为确认帧要尽快发出去，不然发送方会以为丢了

#### RTS/CTS机制（解决隐藏终端和暴露终端）
- **RTS**（Request To Send）：请求发送
- **CTS**（Clear To Send）：允许发送
- **流程**：A发RTS → B回CTS → A发数据 → B回ACK

**解决隐藏终端问题**：
```
场景：A 和 C 都想跟 B 通信，但 A 和 C 互相听不到
```
1. A 先发 RTS 给 B："我要发数据了"
2. B 回 CTS："好的，你发吧"
3. **关键**：C 虽然听不到 A 的 RTS，但能听到 B 的 CTS
4. C 一听到 CTS 就知道："有人在跟 B 通信，我先闭嘴"
5. A 安全地发完数据，避免了在 B 处的冲突

**解决暴露终端问题**：
```
场景：B 想发给 A，C 想发给 D，B 和 C 互相能听到
```
1. B 发 RTS 给 A
2. A 回 CTS 给 B
3. C 听到了 B 的 RTS，但**没听到 A 的 CTS**
4. C 判断："目标站 A 不在我范围内，我发给 D 不会干扰"
5. C 可以放心发给 D，提高了信道利用率

**简单记忆**：
- 听到 CTS → 闭嘴（会干扰别人接收）
- 只听到 RTS 没听到 CTS → 可以发（不会干扰）
---
## CH4: 介质访问控制子层（补充）

### 纯ALOHA协议的最大信道利用率推导（重要简答题）

#### 基本概念

- **吞吐量S**：在发送时间T内发送成功的平均帧数，$0 < S < 1$
- **网络负载G**：时间T内所有通信站总共发送的帧平均值（包括原发和重发的分组），$G \geq S$
- **成功传输概率$P_0$**：一帧发送成功（即未发生冲突）的概率

三者关系：

$$S = G \cdot P_0$$

#### 冲突危险期分析

- 设帧的传输时间为T
- **冲突危险期 = 2T**（一帧发送前T时间内和发送过程中T时间内，都不能有其他帧发送）

#### 计算成功传输概率$P_0$

假设帧的生成服从泊松分布，在时间T内生成k帧的概率为：

$$P[k] = \frac{G^k e^{-G}}{k!}$$

生成0帧的概率（即不生成帧的概率），将k=0代入：

$$P[0] = \frac{G^0 e^{-G}}{0!} = e^{-G}$$

$P_0$的含义是在连续两个T的时间内（即冲突危险期2T内）都没有其它帧生成的概率：

$$P_0 = P[0] \times P[0] = e^{-G} \times e^{-G} = e^{-2G}$$

#### 求吞吐量S的最大值

将$P_0 = e^{-2G}$代入$S = G \cdot P_0$：

$$S = G \cdot e^{-2G}$$

对S求导，令$S' = 0$求极值：

$$S' = \frac{dS}{dG} = e^{-2G} + G \cdot (-2) \cdot e^{-2G} = e^{-2G}(1 - 2G) = 0$$

由于$e^{-2G} > 0$，所以：

$$1 - 2G = 0 \Rightarrow G = 0.5$$

将$G = 0.5$代入$S = G \cdot e^{-2G}$：

$$S_{max} = 0.5 \times e^{-2 \times 0.5} = 0.5 \times e^{-1} = \frac{0.5}{e} \approx \frac{0.5}{2.718} \approx 0.184$$

#### 结论

**纯ALOHA协议的最大信道利用率为18.4%**，此时网络负载$G = 0.5$。

> 补充：时隙ALOHA的冲突危险期为T（而非2T），所以$P_0 = e^{-G}$，$S = G \cdot e^{-G}$，最大利用率为$S_{max} = \frac{1}{e} \approx 36.8\%$（当$G=1$时）。

## CH5:网络层
重点：IPV4的划分 、 ABC类地址。子网划分 大题 路由算法 可能大题 为什么多层次 自治 BGP
1. 网络层的两大功能：**转发**、**路由**
> 路由是"规划路线"，转发是"按路线行驶"。路由算法决定走哪条路，转发表决定从哪个口出去

2. 网络层提供的两种服务：**无连接服务**（数据报）、**面向连接服务**（虚电路）
> 类比：数据报像寄信（每封信独立投递），虚电路像打电话（先建立连接再通话）

### IPV4：
提供**无连接**的数据报服务。
TTL：生存时间(Time To Live):表示数据报在网络中的生命周期，用通过路由器的数量来计量，即跳数（每经过一个路由器会减1）。
> TTL的作用：防止数据报在网络中无限循环（路由错误时）

#### 数据报分片：
> 大概率考计算题


![[Pasted image 20260105113711.png]]![[Pasted image 20260105113733.png]]
> 会做题就行了，MF（More Fragments）标志意思就是还没完，接下来还有分片，偏移量不要忘记**除8**

### IP地址分类：
> 会考的，主要记忆ABC类地址

![[Pasted image 20260105114143.png]]
#### 分类的IP地址
| 类别 | 首位 | 网络号位数 | 主机号位数 | 地址范围 |
|-----|------|-----------|-----------|---------|
| A类 | 0 | 8 | 24 | 1.0.0.0 ~ 126.255.255.255 |
| B类 | 10 | 16 | 16 | 128.0.0.0 ~ 191.255.255.255 |
| C类 | 110 | 24 | 8 | 192.0.0.0 ~ 223.255.255.255 |
| D类 | 1110 | - | - | 224.0.0.0 ~ 239.255.255.255（组播） |

> 快速判断：看第一个数字。1-126是A类，128-191是B类，192-223是C类

#### 特殊IP地址
| 地址 | 用途 |
|-----|------|
| 127.0.0.1 | 回环地址，测试本机TCP/IP协议栈 |
| 0.0.0.0 | 表示任意地址 |
| 255.255.255.255 | 本地广播（有限广播） |
| 主机号全0 | 网络地址（代表整个网络） |
| 主机号全1 | 定向广播地址 |
### 子网划分：
> 会考大题

**题目**：

某公司从ISP处获得了一个连续地址块：192.168.10.0/24

公司内部共有4个部门，需要使用变长子网掩码VLSM进行地址划分，要求：
- 每个部门都在独立子网中
- 尽量节省地址空间，为以后扩展预留部分未使用地址
- 同一部门内所有主机处于同一广播域
- 每个子网中要考虑网络地址、广播地址和主机地址

各部门主机数量需求如下（预留20%富余量）：

| 部门 | 现有主机数 | 预留后需要支持的主机数（向上取整） |
|------|-----------|----------------------------------|
| 研发部 | 60 | ? |
| 市场部 | 25 | ? |
| 财务部 | 12 | ? |
| 行政与人事部门 | 6 | ? |

**问题**：

（1）根据"预留后需要支持的主机数"，为每个部门选择合适的子网大小（CIDR前缀长度），并说明理由。

（2）在192.168.10.0/24地址块内，按照"从主机数需求最大的部门开始划分"的原则，为4个部门依次划分子网，写出每个部门的：
- 网络地址
- 子网掩码（点分十进制和/前缀形式）
- 可用主机地址范围
- 广播地址

（3）划分完成后：
- 还剩余多少IP地址未被分配？
- 这些未分配地址对应哪些子网（给出网络地址和前缀长度即可）？

---

#### 答案

> 做这类题之前，先回顾几个关键知识点，不然容易懵

**前置知识回顾**：

1. **一个子网里不是所有地址都能给主机用**：
   - 网络地址（主机位全0）：不能用，代表这个网络本身
   - 广播地址（主机位全1）：不能用，用于广播
   - 所以：**可用主机数 = 总地址数 - 2**

2. **前缀长度和地址数量的关系**：
   - /24 → 主机位有 32-24=8 位 → $2^8=256$ 个地址 → 可用254台主机
   - /25 → 主机位有 32-25=7 位 → $2^7=128$ 个地址 → 可用126台主机
   - /26 → 主机位有 32-26=6 位 → $2^6=64$ 个地址 → 可用62台主机
   - /27 → 主机位有 32-27=5 位 → $2^5=32$ 个地址 → 可用30台主机
   - /28 → 主机位有 32-28=4 位 → $2^4=16$ 个地址 → 可用14台主机

3. **VLSM划分原则**：从需求最大的开始分，从地址块的起始位置开始分

---

**（1）计算预留后需要支持的主机数及选择子网大小**

**第一步：算出预留20%后需要多少台主机**

| 部门 | 现有主机数 | 计算过程 | 预留后（向上取整） |
|------|-----------|---------|-------------------|
| 研发部 | 60 | 60 × 1.2 = 72 | 72 |
| 市场部 | 25 | 25 × 1.2 = 30 | 30 |
| 财务部 | 12 | 12 × 1.2 = 14.4 | 15 |
| 行政与人事部门 | 6 | 6 × 1.2 = 7.2 | 8 |

**第二步：根据主机数选择合适的子网大小**

> 核心思路：找一个"刚好够用"的$2^n$，要满足 $2^n - 2 \geq$ 需要的主机数

| 部门 | 需要主机数 | 选哪个子网？ | 前缀长度 | 子网掩码 |
|------|-----------|-------------|---------|---------|
| 研发部 | 72 | $2^6-2=62$不够，$2^7-2=126$够 → 选128个地址 | /25 | 255.255.255.128 |
| 市场部 | 30 | $2^5-2=30$刚好够 → 选32个地址 | /27 | 255.255.255.224 |
| 财务部 | 15 | $2^4-2=14$不够，$2^5-2=30$够 → 选32个地址 | /27 | 255.255.255.224 |
| 行政与人事 | 8 | $2^3-2=6$不够，$2^4-2=14$够 → 选16个地址 | /28 | 255.255.255.240 |

> 子网掩码怎么算？以/27为例：前27位是1，后5位是0
> 二进制：11111111.11111111.11111111.11100000
> 转十进制：255.255.255.224

---

**（2）按需求从大到小依次划分子网**

> 划分顺序：研发部(72) → 市场部(30) → 财务部(15) → 行政与人事(8)

**起始地址是 192.168.10.0，我们从这里开始一个一个往后分**

---

**① 研发部（需要128个地址，/25）**

- **网络地址**：192.168.10.0（从起始位置开始）
- **地址范围**：192.168.10.0 ~ 192.168.10.127（共128个）
  - 怎么算结束地址？0 + 128 - 1 = 127
- **可用主机地址**：192.168.10.1 ~ 192.168.10.126
  - 去掉第一个（网络地址.0）和最后一个（广播地址.127）
- **广播地址**：192.168.10.127
- **子网掩码**：255.255.255.128（/25）

| 项目 | 值 |
|------|-----|
| 网络地址 | 192.168.10.0 |
| 子网掩码 | 255.255.255.128（/25） |
| 可用主机地址范围 | 192.168.10.1 ~ 192.168.10.126 |
| 广播地址 | 192.168.10.127 |

**下一个子网从 192.168.10.128 开始**

---

**② 市场部（需要32个地址，/27）**

- **网络地址**：192.168.10.128（接着上一个子网）
- **地址范围**：192.168.10.128 ~ 192.168.10.159（共32个）
  - 怎么算？128 + 32 - 1 = 159
- **可用主机地址**：192.168.10.129 ~ 192.168.10.158
- **广播地址**：192.168.10.159
- **子网掩码**：255.255.255.224（/27）

| 项目 | 值 |
|------|-----|
| 网络地址 | 192.168.10.128 |
| 子网掩码 | 255.255.255.224（/27） |
| 可用主机地址范围 | 192.168.10.129 ~ 192.168.10.158 |
| 广播地址 | 192.168.10.159 |

**下一个子网从 192.168.10.160 开始**

---

**③ 财务部（需要32个地址，/27）**

- **网络地址**：192.168.10.160
- **地址范围**：192.168.10.160 ~ 192.168.10.191（共32个）
  - 怎么算？160 + 32 - 1 = 191
- **可用主机地址**：192.168.10.161 ~ 192.168.10.190
- **广播地址**：192.168.10.191
- **子网掩码**：255.255.255.224（/27）

| 项目 | 值 |
|------|-----|
| 网络地址 | 192.168.10.160 |
| 子网掩码 | 255.255.255.224（/27） |
| 可用主机地址范围 | 192.168.10.161 ~ 192.168.10.190 |
| 广播地址 | 192.168.10.191 |

**下一个子网从 192.168.10.192 开始**

---

**④ 行政与人事部门（需要16个地址，/28）**

- **网络地址**：192.168.10.192
- **地址范围**：192.168.10.192 ~ 192.168.10.207（共16个）
  - 怎么算？192 + 16 - 1 = 207
- **可用主机地址**：192.168.10.193 ~ 192.168.10.206
- **广播地址**：192.168.10.207
- **子网掩码**：255.255.255.240（/28）

| 项目 | 值 |
|------|-----|
| 网络地址 | 192.168.10.192 |
| 子网掩码 | 255.255.255.240（/28） |
| 可用主机地址范围 | 192.168.10.193 ~ 192.168.10.206 |
| 广播地址 | 192.168.10.207 |

---

**（3）剩余未分配地址**

**画个图就清楚了**：

```
192.168.10.0/24 总共256个地址（.0 ~ .255）

|----研发部----|--市场--|--财务--|--行政--|---剩余---|
.0          .127    .159    .191    .207       .255
   128个         32个     32个     16个      48个
```

**已分配**：128 + 32 + 32 + 16 = **208个**

**剩余未分配**：256 - 208 = **48个IP地址**

**未分配地址范围**：192.168.10.208 ~ 192.168.10.255

**这48个地址可以划分为**：
- 192.168.10.208/28（16个地址：.208 ~ .223）
- 192.168.10.224/28（16个地址：.224 ~ .239）
- 192.168.10.240/28（16个地址：.240 ~ .255）

或者合并写成：
- 192.168.10.208/27（32个地址）+ 192.168.10.240/28（16个地址）

### 最长前缀匹配：
#### CIDR（无类域间路由）
**斜线记法**：IP地址/前缀长度，如 192.168.1.0/24

**最长前缀匹配**：路由器转发时，选择与目的IP匹配的**最长前缀**的路由

> 例：目的IP=200.23.24.170
> - 200.23.16.0/21 匹配21位
> - 200.23.24.0/24 匹配24位 ← 选择这条（更具体）

![[Pasted image 20260105122914.png]]
显然到**Interface D**

**DHCP（动态主机配置协议）**：允许主机从服务器动态获取IP地址
**工作模式**：**客户端/服务器**（C/S）模式，基于UDP（服务器67端口，客户端68端口）

**DHCP工作过程（四步）：**
```
1. DHCP Discover（发现）
   客户端广播：源IP=0.0.0.0，目的IP=255.255.255.255
   "有没有DHCP服务器？"

2. DHCP Offer（提供）
   服务器响应：提供可用的IP地址和配置信息
   "我可以给你这个IP地址"

3. DHCP Request（请求）
   客户端广播：选择一个服务器的offer
   "我要用你提供的IP地址"

4. DHCP ACK（确认）
   服务器确认：正式分配IP地址
   "好的，这个IP地址归你了"
```

> DHCP不仅分配IP地址，还提供：默认网关、DNS服务器、子网掩码等

### ARP协议
**ARP（地址解析协议）**：根据IP地址获取对应的MAC地址

**为什么需要ARP？**
- IP地址是逻辑地址，用于网络层寻址
- MAC地址是物理地址，用于链路层实际传输
- 发送数据帧需要知道目的MAC地址

**ARP工作过程：**
```
1. A想发送数据给B，知道B的IP，不知道B的MAC
2. A检查本地ARP缓存，没有B的记录
3. A广播ARP请求："谁的IP是xxx？请告诉我你的MAC"
4. B收到请求，单播回复ARP响应："我的MAC是xxx"
5. A收到响应，缓存B的IP-MAC映射，发送数据
```

> ARP缓存有超时机制，过期后需要重新查询

**跨网络通信时的ARP：**
- A和B不在同一子网时，A需要先获取**默认网关**的MAC地址
- 数据帧的目的MAC是网关的MAC，但IP数据报的目的IP仍是B的IP
